var E_LAYERLABEL=Object({current:"_current",mouse:"_mouse",grid:"_gris",prefrag:"_prefrag"});function callback_stub(){}function helper_get_classname(j){return"undefined"===typeof j?"undefined":null===j?"null":Object.prototype.toString.call(j).match(/^\[object\s(.*)\]$/)[1]}function helper_bound_value(j,f,i){j<=f?j=f:j>=i&&(j=i);return Math.floor(j)}var near_zero_tolerance=0.01;function near_zero(j){return j<near_zero_tolerance&&j>-near_zero_tolerance?!0:!1}
function helper_format_number_length(j,f){for(var i=""+j;i.length<f;)i="0"+i;return i}function getObjectClass(j){if("object"!=typeof j||null===j)return!1;console.log(j.constructor.toString());return/^function (\w+)\(/.exec(j.constructor.toString())[1]}
function cEach(j,f){this.ret=!1;this.run=!0;if(void 0==j)return console.error("Cannot iterate over null thing"),!1;if(!f||"function"!=typeof f)return console.error("No callback assigned to cEeach"),!1;if(j instanceof Array)for(var i=0;i<j.length&&this.run;i++)f.call(this,i,j[i]);else if(j instanceof Object)for(elm in console.log("Each array"),j){if(!this.run)break;j.hasOwnProperty(elm)&&f.call(this,elm,j[elm])}else this.exception("invalid_thing");return this.ret}
cEach.prototype.stop=function(j){console.log("stop",j);this.run=!1;this.ret=j};function Cenum(j){for(o in j)this[o]=j[o]}Cenum.prototype.key_by_value=function(j){for(label in this)if(this.hasOwnProperty(label)&&this[label]==j)return label;console.error("No enum found with value",j);return""};
function widget_factory(j,f){f=f||{};if(!j)throw"func_widget_factory_need_dom";console.log("Widget factory",j,f);var i={autoOpen:!0,resizable:!0,draggable:!0,width:250,zIndex:10,dialogClass:"shojs-dialog",stack:!0},h;for(h in i)h in f||(f[h]=i[h]);j.dialog(f);return j}window.widget_factory=window.widget_factory;
function widget_exception(j){var f=graphit.import("lib/exception");console.error("Widget",j);var i=j,h="[Error] ";j instanceof f&&(i=j.to_s({format:"html"}),h=h+j.className+"/"+j.label);f=$('<div title="'+h+'" />');f.append($("<p>"+i+"<p/>"));f.dialog({modal:!0});throw j;}window.widget_exception=window.widget_exception;
function deleteAllCookies(j){for(var j=j||window.document,f=j.cookie.split(";"),i=0;i<f.length;i++){var h=f[i];console.log("Delete cookie",h);var e=h.indexOf("="),h=-1<e?h.substr(0,e):h;j.cookie=h+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"}(j=window.opener)&&deleteAllCookies(j.document)};(function(j,f,i){var h=10<f.debug?!0:!1,j=function(){this.prefix="shojs-";this.postfix="graphit";this.id=null;this.className="lib/uid"};j.prototype.init=function(){};j.prototype.init=j.prototype.init;j.prototype.__get_frag=function(){var e=Math.round(Math.random()*Date.now()/655350),e=parseInt((e+"").slice(0,5));return helper_format_number_length(e,5)};j.prototype.__get_frag=j.prototype.__get_frag;j.prototype.gen=function(){for(var e=this.prefix,d=0;2>d;d++)e+=this.__get_frag()+"-";return this.last_id=
e+=this.postfix};j.prototype.gen=j.prototype.gen;j.prototype.__test=function(){var e=new (f.import("lib/uid"));h&&(i.log(e),i.log("Testing uid",e.gen()));return!0};j.prototype.__test=j.prototype.__test;f.export("lib/uid",j)})(window,graphit,console);(function(j,f,i){var h=10<=f.debug?!0:!1,j=function(e){e=e||{};EXCEPTION={_ALL:{method_object_missing:"This object doesn't have the required method (See additional)"},Csurface:{invalid_width:"The specified width is invalid 0 < width < 1920",invalid_height:"The specified height is invalid 0 < height < 1920"},Ccanvas:{invalid_width:"The specified width is invalid 0 < width < 1920",invalid_height:"The specified height is invalid 0 < height < 1920",invalid_copy_source:"You're trying to copy something that is not a Ccanvas or who is null"},
Cmenu:{invalid_menu_entry:"Your are trying to add non Cmenu_entry object",label_already_present:"Label already set in this menu"},Ctool:{no_size_parameter:"Each tool require a size Cparameter"}};this.type="shojs-exception";this.className=e.className||"no object";this.label=e.label;this.additional=e.additional;this.object=e.object;this.original=e.original;this.message=null;this.className in EXCEPTION&&this.label in EXCEPTION[this.className]&&(this.message=EXCEPTION[this.className][this.label]);!this.message&&
this.label in EXCEPTION._ALL&&(this.message=EXCEPTION._ALL[this.label])};j.prototype.__test=function(){var e=new (f.import("lib/exception"))("TEST_EXCEPTION");try{throw e;}catch(d){h&&i.log(d.to_s())}return!0};j.prototype.__test=j.prototype.__test;j.prototype.to_s=function(e){var d="\n";void 0!=e&&"format"in e&&"html"==e.format&&(d="<br>"+d);e="["+this.type+"]"+d+d;for(label in this)this.hasOwnProperty(label)&&(e="object"==typeof this[label]&&this[label]?e+(label+": "+this[label].toString()+d):e+
(label+": "+this[label]+d));return e};j.prototype.to_s=j.prototype.to_s;f.export("lib/exception",j)})(window,graphit,console);(function(j,f,i,h){var e=f.import("lib/uid"),d=function(a,d){a=a||{};a.className=a.className||"lib/object";a.label=a.label||"object";this.uid=null;if(a!=h){if(!(a instanceof Object))throw i.error("[Module/Constructor] Options must be hash aka Object",this),"[Module/Constructor] Options must be hash aka Object";this.parent=null;this.parameters={};this._class_init(a,d);try{this.init(a,d)}catch(l){throw i.error("Cannot init object << ",this," >> Exception <<< ",l," >>>"),l;}}};d.prototype._class_init=
function(a,d){this.uid=(new e).gen();this.callback={};this._parse_options(a,d);return this};d.prototype._class_init=d.prototype._class_init;d.prototype.init=function(){return!1};d.prototype.init=d.prototype.init;d.prototype.exception=function(a,d,l){a=new (f.import("lib/exception"))({className:this.className,label:a,additional:d,object:this});i.error(a.to_s());i.log("Options",l);l&&("dialog"in l&&l.dialog)&&widget_exception(a);throw a;};d.prototype.exception=d.prototype.exception;d.prototype._parse_options=
function(a,d){if(a==h)i.warn("No << {} >> argument passed to new Module");else{for(var d=d||[],l=["className","label"],e=0;e<l.length;e++)!(l[e]in a)&&!a[l[e]]?this.exception("missing_mandatory_parameter",l[e]):d.push(l[e]);for(e=0;e<d.length;e++){var m=d[e];m in a?this[m]=a[m]:10<=j.graphit.debug&&i.warn("Needed property <<",m,">> ")}this._permitted_keys=d;if("parameters"in a)for(var f in a.parameters)this.add_parameter(a.parameters[f]);l=/^callback_(.*)$/;for(m in a)(e=l.exec(m))&&(e[1]in this.callback?
i.error("Callback",e[1],"already installed skipping..."):this.callback[e[1]]=a[m]);return!0}};d.prototype._parse_options=d.prototype._parse_options;d.prototype.install_callback=function(a){(!a||!("name"in a)||!("callback"in a)||"function"!=typeof a.callback)&&this.exception("install_callback_bad_arguments",a);a.name in this.callback&&this.exception("install_callback_already_registered",a);this.callback[a.name]=a.callback};d.prototype.install_callback=d.prototype.install_callback;d.prototype.guid=
function(a){return(""+this.className+"-"+this.uid+(a?"-"+a:"")).toLowerCase()};d.prototype.guid=d.prototype.guid;d.prototype.get_trigger_name=function(a){return this.guid(a)};d.prototype.get_trigger_name=d.prototype.get_trigger_name;d.prototype.send_trigger=function(a,d){var l=this.get_trigger_name(a);4<j.graphit.debug&&i.log("[trigger/send]",l,d);$(document).trigger(l,d)};d.prototype.send_trigger=d.prototype.send_trigger;d.prototype.set=function(){throw"Not_implemented";};d.prototype.set=d.prototype.set;
d.prototype.bind_trigger=function(a,d,l){if(!a)return i.warn("Cannot bind to null object"),!1;a=a.get_trigger_name(d);4<j.graphit.debug&&i.debug("[trigger/bind]",d,this.className," => ",a);$(document).bind(a,function(a,d){l.call(this,a,d)});return!0};d.prototype.bind_trigger=d.prototype.bind_trigger;d.prototype.add_parameter=function(a){var d=f.import("lib/parameter/select"),l=f.import("lib/parameter/numeric"),e=f.import("lib/parameter"),m=f.import("lib/parameter/enum/type");i.log("Add parameter",
a);new e;"parent"in a||(a.parent=this);"label"in a||this.exception("parameter_need_label",a);!("type"in a)||a.type==m.numeric?this.parameters[a.label]=new l(a):a.type==m.select?this.parameters[a.label]=new d(a):this.exception("unknow_parameter_type");return!0};d.prototype.add_parameter=d.prototype.add_parameter;d.prototype.get_parameter=function(a){(!("parameters"in this)||!(a in this.parameters))&&this.exception("accessing_unknow_parameter",a);return this.parameters[a].get()};d.prototype.get_parameter=
d.prototype.get_parameter;d.prototype.callback_exists=function(a){return a in this.callback&&"function"==typeof this.callback[a]?this.callback[a]:null};d.prototype.callback_exists=d.prototype.callback_exists;d.prototype.dom_get=function(a){a=a||{};a.force=!1;var d=this.rootElm;if(a.force||!d)d=this.dom_build().rootElm;if("noHeader"in a&&a.noHeader)return d;a=$("<div />");a.attr("id",this.uid);a.attr("title",this.label);a.addClass((this.className+"-"+this.label).toLowerCase());a.append(d);return a};
d.prototype.dom_get=d.prototype.dom_get;d.prototype.add_widget=function(a,d){(!a||!d)&&this.exception("no_name_or_root_elm",{name:a,rootElm:d});"widgets"in this||(this.widgets={});a in this.widgets&&this.exception("dialog_already_exist",a);this.widgets[a]=d;return this};d.prototype.add_widget=d.prototype.add_widget;d.prototype.to_s=function(a){var a=a||"\n",d="["+this.className+"]"+a,d=d+(" - uid: "+this.uid+a);return d+=" - trigger name: "+this.get_trigger_name()+a};d.prototype.to_s=d.prototype.to_s;
d.prototype.get_widget=function(a){(!a||!(a in this.widgets))&&this.exception("no_widget_with_this_name",{name:a});return this.widgets[a]};d.prototype.get_widget=d.prototype.get_widget;d.prototype.__test=function(){new (f.import("lib/object"))({parent:this,label:"Test",className:"Test"});return!0};d.prototype.__test=d.prototype.__test;f.export("lib/object",d)})(window,graphit,console);(function(j,f,i){var h=10<=f.debug?!0:!1,e=function(){this.className="lib/localStorage";this.init()};e.prototype.init=function(){this.test_compatibility()?(this.store=j.localStorage,this.test_insert()||(this.store={})):this.store={}};e.prototype.first_install=e.prototype.first_install;e.prototype.test_compatibility=function(){if("localStorage"in j&&null!=j.localStorage)return!0;i.error("Your web browser doesn't support web storage");return!1};e.prototype.test_compatibility=e.prototype.test_compatibility;
e.prototype.test_insert=function(){try{this.set("_____TEST_INSERT_VALUE_____","_____TEST_INSERT_VALUE_____")}catch(d){return!1}this.remove("_____TEST_INSERT_VALUE_____");return!0};e.prototype.test_insert=e.prototype.test_insert;e.prototype.list=function(){return this.store};e.prototype.list=e.prototype.list;e.prototype.remove=function(d){h&&i.log("Removing key",d);if("removeItem"in this.store)return this.store.removeItem(d);delete this.store[d]};e.prototype.remove=e.prototype.remove;e.prototype.get=
function(d){h&&i.log("Get key",key);return this.store&&d in this.store?this.store[d]:null};e.prototype.get=e.prototype.get;e.prototype.set=function(d,a){h&&i.log("Setting",d,"with",a,"into",this.store);this.store||i.error("Storage not set");try{"removeItem"in this.store&&this.store.removeItem(d),this.store[d]=a}catch(e){var l=new Cexception_message({label:"store_new_value_failed",className:this.className,object:this,additional:"key: "+d+" / value: "+a,original:e});i.error(l.to_s(),e)}};e.prototype.set=
e.prototype.set;e.prototype.__test=function(){var d=new (f.import("lib/localStorage"));d.set("__TEST__","__TEST__");var a=d.get("__TEST__");if("__TEST__"!=a)throw d.className+"_cannot_fetch_key";for(var e in d.list())a=d.get(e),h&&i.log(e,a);d.remove("__TEST__");for(e in d.list())a=d.get(e),h&&i.log(e,a);return!0};e.prototype.__test=e.prototype.__test;f.export("lib/localStorage",e)})(window,graphit,console);(function(j,f,i){var h=10<f.debug?!0:!1,e=f.import("lib/object"),d=f.import("lib/exception"),j=function(a){this.PO=this.PO={en:{menu_new_surface:"New",menu_theme:"Theme",menu_about:"About",menu_toolbox:"Toolbox",menu_file:"File",menu_help:"Help",menu_edition:"Edition",menu_login:"Login",menu_logout:"Logout",foreground_color:"Foreground color",background_color:"Background color",layers:"Layers",switch_color:"Switch color",tool_pencil:"Pen",tool_paintbrush:"Brush",tool_eraser:"Eraser","tool_bucket-fill":"Fill",
"tool_color-picker":"Color picker",right_click_to_save:"Right click -> Save as",save_image:"Save image",save:"Save",open:"Open",load:"Load",load_image:"Load image (URL)"},fr:{menu_new_surface:"Nouveau",menu_theme:"Theme",menu_about:"A propos",menu_file:"Fichier",menu_help:"Aide",menu_edition:"Edition",menu_toolbox:"Outils",foreground_color:"Couleur principal",background_color:"Couleur de fond",layers:"Calques",switch_color:"Echange de couleur",tool_pencil:"Crayon",tool_paintbrush:"Pinceau",tool_eraser:"Gomme",
"tool_bucket-fill":"Remplir","tool_color-picker":"Selection de couleur",right_click_to_save:"Clique droit -> Enregistrer l'image sous",save:"Sauver",open:"Ouvrir",load:"Charger",load_image:"Charger image (URL)"}};this.label=null;this.def="en";a=a||{};a.className="lib/po";a.label="po";a.def="en";a.lang=a.lang||a.def;e.call(this,a,["lang","def"])};j.prototype=Object.create(e.prototype);j.prototype.constructor=new e;j.prototype.get=function(a){var e=this.def,l=this.lang||e,n=null;if(l in this.PO&&a in
this.PO[l])n=this.PO[l];else if(e in this.PO&&a in this.PO[e])n=this.PO[e];else throw new d({className:this.className,label:"no_trad_and_no_def",object:this,additional:a});return n[a]};j.prototype.get=j.prototype.get;j.prototype.to_s=function(a){var a=a||{},a=a.nl||"\n",d="["+this.className+"]"+a,d=d+(" - label: "+this.label+a),e;for(e in this.PO){var d=d+("--- LANG "+e+a),n;for(n in this.PO[e])d+=" - "+n+" => "+this.PO[e][n]+a}return d};j.prototype.to_s=j.prototype.to_s;j.prototype.set_lang=function(a){this.lang=
a};j.prototype.set_lang=j.prototype.set_lang;j.prototype.__test=function(){var a=new (f.import("lib/po"))({lang:"en"}),d;for(d in a.PO){h&&i.log("Lang <<<",d,">>>");for(var e in a.PO[d]){var n=a.get(e);h&&(i.log("Label to translate: "+e),i.log(" - Translate",n))}}h&&i.log("Setting lang to","fr");a.set_lang("fr");h&&i.log(a.to_s());return!0};j.prototype.__test=j.prototype.__test;f.export("lib/po",j)})(window,graphit,console);(function(j,f,i){j={numeric:1,select:2,checkbox:3};i.log("Module",j);f.export("lib/parameter/enum/type",j)})(window,graphit,console);(function(j,f,i,h){var e=f.import("lib/object"),d=f.import("lib/localStorage"),a=f.import("lib/parameter/enum/type"),k=function(a){a=a||{};a.className=a.className||"lib/parameter";a.autoSave="autoSave"in a&&a.autoSave?!0:!1;a.label=a.label||"parameter";"parameters"in a&&this.exception("no_parameter_for_me");e.call(this,a,["type","def","label","autoSave","parent"]);this.autoSave&&(this.store=new d);this.__post_init(a);return this};k.prototype=Object.create(e.prototype);k.prototype.constructor=new e;
k.prototype.__post_init=function(a){if(this.autoSave){var d=this.make_registry_key();0<j.graphit.debug&&i.log("Loading parameter",d);d=this.store.get(d);this.value=d!=h?this._set(d):this._set(this.def)}else this.value=this._set(this.def);this.rootElm=null;var d=/^callback_(.*)$/,e;for(e in a)d.exec(e)&&(a[e]&&"function"==typeof a[e])&&(10<j.graphit.debug&&i.log("Installing callback for parameter["+this.type+"]",e),this[e]=a[e])};k.prototype.__post_init=k.prototype.__post_init;k.prototype.set=function(a){if(this.value==
a)return!1;this.value=this._set(a);this.autoSave&&(a=this.make_registry_key(),this.store.set(a,this.value));return!0};k.prototype.set=k.prototype.set;k.prototype._set=function(a){return a};k.prototype._set=k.prototype._set;k.prototype.reset=function(){this.set(this.def);return this.get()};k.prototype.reset=k.prototype.reset;k.prototype.get=function(){return this._get(this.value)};k.prototype.get=k.prototype.get;k.prototype._get=function(a){return a};k.prototype._get=k.prototype._get;k.prototype.make_registry_key=
function(){var a=this.parent.className||this.className,d=this.parent.label;a||this.exception("no_classname_in_parent");d||this.exception("no_label_in_parent");return(a+"-"+d+"-"+this.label).toLowerCase()};k.prototype.make_registry_key=k.prototype.make_registry_key;k.prototype.to_s=function(a){a=a||{};nl=a.nl||"\n";a="["+this.className+"]"+nl;return a+=" - label: "+this.label+nl};k.prototype.to_s=k.prototype.to_s;k.prototype.__test=function(){(new (f.import("lib/parameter"))({autoSave:!0,parent:{className:"classTest",
label:"labelTest"},def:"Test",type:a.numeric})).set("__TEST__","__TEST__");return!0};k.prototype.__test=k.prototype.__test;f.export("lib/parameter",k)})(window,graphit,console,void 0);(function(j,f,i){function h(d){d=d||{};d.className=e;d.parent=d.parent||{className:"fakeClassName",label:"fakeLabel"};i.log("Parent",d.parent);d.autoSave="autoSave"in d&&!d.autoSave?!1:!0;a.call(this,d,"autoSave def label type choices parent".split(" "));this.type=k.select}var e="lib/parameter/select",d=5<f.debug?!0:!1,a=f.import("lib/parameter"),k=f.import("lib/parameter/enum/type");h.prototype=Object.create(a.prototype);h.prototype.constructor=new a;h.prototype.init=function(a){this.choices={};
this.def=a.def;this.label=a.label;this.type=a.type;for(var d in a.choices)this.choices[d]=a.choices[d]};h.prototype.init=h.prototype.init;h.prototype.dom_build=function(){this.rootElm=this.rootElm;this.label=this.label;this.choices=this.choices;var a=this,e=$('<div title="'+this.className+'">');e.addClass("selected parameter");e.append("<h6>"+this.label+"</h6>");var k=$("<select />"),f;for(f in this.choices){d&&i.log("Option",this.choices[f]);var h=$("<option/>");h.attr("value",this.choices[f]);this.value==
this.choices[f]&&h.attr("selected","selected");h.append(document.createTextNode(this.choices[f]));k.append(h)}k.change(function(){a.set(this.value);a.rootElm.find("option").each(function(){$(this)});"callback_change"in a&&a.callback_change.call(a,this.value)});e.append(k);this.rootElm=e;return this};h.prototype.dom_build=h.prototype.dom_build;h.prototype.__test=function(){var a=(new (f.import(e))({parent:{className:e,label:e},label:"Test parameter select",def:"test01",choices:["test01","test02","test03"]})).dom_get();
widget_factory(a);return!0};h.prototype.__test=h.prototype.__test;f.export(e,h)})(window,graphit,console);(function(j,f,i){var h=f.import("lib/localStorage"),j=function(e){this.className="app/jquery/themeInjector";this.key="cjquery-theme-chooser-name";this.name=e||"south-street";this.ls=new h;this.init(this.name);this.inject_script(this.name)};j.prototype.__test=function(){new (f.import("app/jquery/themeInjector"))};j.prototype.__test=j.prototype.__test;j.prototype.init=function(e){var d=this.ls.get(this.key);d?this.name=d:(this.ls.set(this.key,e),this.name=e)};j.prototype.init=j.prototype.init;j.prototype.inject_script=
function(e){var d=document.getElementById("ui-theme"),e=f.baseStaticContent+"js/plugin/jquery-ui/1.9.2/themes/"+e+"/jquery-ui.css";d?d.setAttribute("href",e):(d=document.createElement("link"),d.setAttribute("rel","stylesheet"),d.setAttribute("id","ui-theme"),d.setAttribute("href",e),i.log("[Injecting/css]",e),document.getElementsByTagName("head")[0].appendChild(d))};j.prototype.inject_script=j.prototype.inject_script;f.export("app/jquery/themeInjector",j)})(window,graphit,console);(function(j,f,i,h){function e(){var a=f.import("lib/parameter/select");this.className=d;this.label="chooser";this.key="shojs-jquery-theme";this.pTheme=this.pTheme=new a({parent:this,label:"name",choices:{base:"base",black_tie:"black-tie",blitzer:"blitzer",cupertino:"cupertino",dark_hive:"dark-hive",dot_luv:"dot-luv",eggplant:"eggplant",excite_bike:"excite-bike",flick:"flick",hot_sneaks:"hot-sneaks",humanity:"humanity",le_frog:"le-frog",mint_choc:"mint-choc",overcast:"overcast",pepper_grinder:"pepper-grinder",
redmond:"redmond",smoothness:"smoothness",south_street:"south-street",start:"start",sunny:"sunny",swanky_purse:"swanky-purse",trontastic:"trontastic",ui_darkness:"ui-darkness",ui_lightness:"ui-lightness",vader:"vader"},def:"base",callback_change:function(a){a=j.graphit.baseStaticContent+"js/plugin/jquery-ui/1.9.2/themes/"+a+"/jquery-ui.css";i.log("src",a);$("#ui-theme").attr("href",a)}});this.rootElm=null;return this}var d="app/jquery/theme";e.prototype.dom_build=function(){var a=$('<div title="Theme chooser"/>');
a.append(this.pTheme.dom_get());this.rootElm=a;return this};e.prototype.dom_build=e.prototype.dom_build;e.prototype.dom_get=function(a){return this.rootElm&&a!=h&&!a?this.rootElm:this.dom_build().rootElm};e.prototype.dom_get=e.prototype.dom_get;e.prototype.__test=function(){(new (f.import("Module"))).dom_get().dialog()};e.prototype.__test=e.prototype.__test;f.export(d,e)})(window,graphit,console);(function(j,f,i){function h(e){e=e||{};e.className=d;e.label="checkbox";e.autoSave="autoSave"in e&&!e.autoSave?!1:!0;a.call(this,e);this.type=k.checkbox}var e=10<f.debug?!0:!1,d="lib/parameter/checkbox",a=f.import("lib/parameter"),k=f.import("lib/parameter/enum/type");h.prototype=Object.create(a.prototype);h.prototype.constructor=new a;h.prototype.init=function(){this.choices={}};h.prototype._get=function(a){return"true"==a?!0:"false"==a?!1:a?!0:!1};h.prototype._set=function(a){(a="false"==a||!a?
!1:!0)?this.rootElm&&this.rootElm.find("input").attr("checked","checked"):(this.value=!1,this.rootElm&&this.rootElm.find("input").removeAttr("checked"));return a};h.prototype.dom_build=function(){var a=this,d=$("<div />");d.addClass("selectex parameter");d.append("<h6>"+this.label+"</h6>");var e=$("<input />");e.attr("type","checkbox");e.attr("title",label);this.value&&(e[0].checked="checked");e.change(function(){a.set(this.checked);"callback_change"in a&&a.callback_change.call(a,e[0].checked)});
d.append(e);this.rootElm=d;return a};h.prototype.__test=function(){e&&i.log("Overide Cparameter test ...")};h.prototype.__test=h.prototype.__test;f.export(d,h)})(window,graphit,console);(function(j,f,i,h){var e=f.import("lib/parameter"),d=f.import("lib/parameter/enum/type"),j=function(a){a.type=d.numeric;a.className="lib/parameter/numeric";a.autoSave="autoSave"in a&&!a.autoSave?!1:!0;e.call(this,a);return this};j.prototype=Object.create(e.prototype);j.prototype.constructor=new e;j.prototype.init=function(a){this.checks=Object({label:1,min:1,max:1,def:1,step:1});for(var d in this.checks){if(!(d in a)||a[d]===h)return i.error("Missing parameter key/value",a,d),null;this[d]="label"==
d?a[d]:parseFloat(a[d])}};j.prototype._get=function(a){return parseFloat(a)};j.prototype._set=function(a){return parseFloat(a)};j.prototype.dom_build=function(){var a=this,d=$("<div />");d.addClass("sliderex parameter "+this.label);d.attr("title",this.label);var e=$("<table />"),f=$("<tr />"),m=$("<td />");m.append("<h6>"+this.label+"</h6>");f.append(m);var i=$("<div />");i.addClass("slider");i.slider({min:this.min,max:this.max,value:this.value,step:this.step,slide:function(){var d=$(this),e=d.slider("option",
"value");a.set(e);d.parents(".sliderex").find("input.input").attr("value",e);"callback_slide"in a&&a.callback_slide.call(a,e)},change:function(){var d=$(this),e=d.slider("option","value");a.set(e);d.parents(".sliderex").find("input.input").attr("value",e);"callback_change"in a&&a.callback_change.call(a,e)}});m=$("<td />");m.append(i);f.append(m);i=$("<input />");i.addClass("input");i.attr("value",this.value);i.css("width: 2em");i.change(function(){var d=$(this),e=d.attr("value");d.parents(".sliderex").find(".slider").slider("option",
"value",e);a.set(e);"callback_change"in a&&a.callback_change.call(a,e)});i.spinner();m=$("<td />");m.append(i);f.append(m);e.append(f);d.append(e);this.rootElm=d;return this};f.export("lib/parameter/numeric",j)})(window,graphit,console);(function(j,f){f.export("lib/enum/loading",{none:1,loading:2,fail:3,ok:4})})(window,graphit,console);(function(j,f){f.export("lib/enum/cardinal",{nw:7,n:0,ne:1,w:6,e:2,sw:5,s:4,se:3})})(window,graphit,console);(function(j,f,i,h){function e(e){e=e||{};e.className=d;e.label=e.label||"image";a.call(this,e,"parent src width height title callback_click callback_success callback_error autoRelease".split(" "));this.options=e;this.data=null;this.status=k.none;this.errorMsg="";this.last_update=null;this.src||i.warn(this.className+" constructed without src argument");this.dom_get()}var d="lib/image",a=f.import("lib/object"),k=f.import("lib/enum/loading");e.prototype=Object.create(a.prototype);e.prototype.constructor=
new a;e.prototype.dom_build=function(){var a=this;if(this.rootElm&&!force)return i.warn("Image already loaded"),this;var d=$("<img />");d[0].onload=function(){return a.callback_onload.call(a)};d[0].onerror=function(){return a.callback_onerror.call(a)};d.click(function(){return a.callback_click.call(a)});"label"in this&&this.label!=h&&(d.attr("alt",this.label),d.attr("title",this.label));"width"in this&&this.width!=h&&d.attr("width",this.width);"height"in this&&this.height!=h&&d.attr("height",this.height);
"src"in this&&this.src&&d.attr("src",this.src);this.rootElm=d;return this};e.prototype.callback_onload=function(){this.status=k.ok;this.last_update=Date.now();if("replace_id"in this.options&&this.options.replace_id){var a=document.getElementById(this.options.replace_id);a?("label"in this.options&&a.setAttribute("alt"),a.width=this.data.width,a.height=this.data.height,a.src=this.data.src):(this.errorMsg="Replacing image failed",ret=!1)}return(a=this.callback_exists("success"))?a.call(this):!1};e.prototype.callback_onerror=
function(){this.status=k.fail;this.last_update=null;var a=this.callback_exists("error");return a?a.call(this):!1};e.prototype.callback_click=function(){var a=this.callback_exists("click");return a?a.call(this):!1};e.prototype.__test=function(){i.log("Overide Cobject.__test");return!0};e.prototype.__test=e.prototype.__test;f.export(d,e)})(window,graphit,console);(function(j,f,i){function h(a){a=a||{};a.className=e;a.size=a.size||22;a.type=a.type||"gimp";a.format=a.format||"png";a.label=a.label||"icon";a.path=a.path?"/"+a.path+"/":"/";a.name=a.name||"icon";a.src=this._build_src_path(a);d.call(this,a,["name","format","size","path"])}var e="lib/icon",d=f.import("lib/image");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype._build_src_path=function(a){var d=j.graphit.baseStaticContent;a.name||this.exception("mandatory_parameter_missing",
"name",this);return d+"/images/"+a.type+a.path+a.name+"-"+a.size+"."+a.format};h.prototype.__test=function(){i.log("overide Cobject.__test");return!0};h.prototype.__test=h.prototype.__test;f.export(e,h)})(window,graphit,console);(function(j,f,i,h){function e(a){a=a||{};a.className="Module";a.label="color";"r"in a||(a.r=0);"g"in a||(a.g=0);"b"in a||(a.b=0);"a"in a||(a.a=0);d.call(this,a,["r","g","b","a","callback_change"])}var d=f.import("lib/object");e.prototype=Object.create(d.prototype);e.prototype.constructor=new d;e.prototype.to_rgba=function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.a+")"};e.prototype.set_rgb=function(a){this.r=a.r;this.g=a.g;this.b=a.b;this.a=1;(callback=this.callback_exists("change"))&&
callback.call(this);return this};e.prototype.set=function(a,d){callback=this.callback_exists("change");if(a instanceof e)return this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a,callback&&callback.call(this),this;if(a&&d!=h){if(a in this)return this[a]=d,callback&&callback.call(this),this;this.exception("invalid_color_key",a)}this.exception("invalid_set_value",{key:a,value:d})};e.prototype.from_rgba=function(a){var d=RegExp(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+(\.\d+)?)\s*\)$/).exec(a);if(!d)return i.error("Invalid rgba expression: "+
a),this;this.r=d[1];this.g=d[2];this.b=d[3];this.a=d[4];return this};e.prototype.inverse=function(){var a=1/255;this.r=Math.round(255*(1-this.r*a));this.g=Math.round(255*(1-this.g*a));this.b=Math.round(255*(1-this.b*a));return this};e.prototype.from_pixel=function(a,d){if(a==h||d==h)throw"invalid_argument";var e=d.y*4*a.width+4*d.x,f=a.data;this.r=f[e];this.g=f[e+1];this.b=f[e+2];this.a=f[e+3];this.a=Math.round(100*(this.a/255))/100;return this};e.prototype.clone=function(){return new e(this)};e.prototype.equal=
function(a,d){for(var e=d||["a","r","g","b"],f,m=0;m<e.length;m++)if(f=e[m],this[f]!=a[f])return!1;return!0};e.prototype.magnitude=function(){return Math.sqrt(this.r*this.r+this.g*this.g+this.b*this.b)};e.prototype.normalize=function(){var a=this.magnitude();this.r/=a;this.b/=b;this.g/=g;return this};e.prototype.to_s=function(){return this.className+"("+this.r+", "+this.g+", "+this.b+", "+this.a+")\n"};f.export("lib/color",e)})(window,graphit,console);(function(j,f,i,h){function e(a){a=a||{};a.className="Module";a.label="Module";d.call(this,a,["source_points","image_data"])}var d=f.import("lib/object"),a=f.import("lib/color");f.import("lib/enum/cardinal");e.prototype=Object.create(d.prototype);e.prototype.constructor=new d;e.prototype.get_cardinal_pixel=function(a,d,e){var f=d.x,d=d.y,i=a.width,j=i*a.height,q=[],a=function(a,d){var f=d*i+a;e[f]==h&&0<=f&&f<j&&q.push({x:a,y:d,index:f})};a(f,d-1);a(f+1,d-1);a(f+1,d);a(f+1,d+1);a(f,d+1);a(f-1,d+1);
a(f-1,d);a(f-1,d-1);return q};e.prototype.select_adjacent_pixel=function(a,d,e,f){a=this.get_cardinal_pixel(a,d,e);for(d=0;d<a.length;d++)f.call(this,a[d])};e.prototype.adjacent_by_color=function(d,e){for(var f=[],i=[],h=d.width*d.height,j=0;j<h;j++)f[j]=null;i.push({x:e.x,y:e.y,index:e.y*d.width+e.x});for(var q=0,h=0,s=(new a).from_pixel(d,e);0<i.length;)j=i.pop(),h++,this.select_adjacent_pixel(d,j,f,function(e){var l;l=(new a).from_pixel(d,e);l=s.equal(l,["r","g","b"])?!0:!1;l?(q++,f[e.index]=1,
i.push(e)):f[e.index]=0});return f};f.export("lib/image/analyse",e)})(window,graphit,console);(function(j,f){function i(d){d=d||{};d.className=h;d.label=d.label||"menu";d.type=d.type||"jquery";this.entries={};this.num_child=0;e.call(this,d,["type","parent","cssClass"])}var h="lib/menu",e=f.import("lib/object");i.prototype=Object.create(e.prototype);i.prototype.constructor=new e;i.prototype.init=function(d){for(var a in d.entries)d.entries[a].parent=this,d.entries[a].type=this.type,this.add(new i(d.entries[a]))};i.prototype.exists=function(d){return d.label in this.entries?!0:!1};i.prototype.add=
function(d){(!d||!(d instanceof i))&&this.exception("invalid_menu_entry",d);this.exists(d)&&this.exception("label_already_present",d.label);this.entries[d.label]=d;this.num_child++};i.prototype.dom_build=function(){var d;d=parent in this&&this.parent instanceof i?this.parent.rootElm:$("<ul />");for(var a in this.entries){var e=this.entries[a],f=$('<a href="#" title=""/>');f.attr("label",a);"click"in e.callback&&e.install_callback(f);var h=$("<li />"),m=$("<span>"+a+"</span>");m.addClass("menu-entry");
this.cssClass&&m.addClass(this.cssClass);f.append(m);h.append(f);e.has_child()&&(e=e.dom_get({noHeader:!0}),h.append(e));d.append(h)}if("jquery"==this.type&&(!this.parent||!(this.parent instanceof i)))d.menu({role:"listbox"}),d.menu("enable");if(!this.parent||!(this.parent instanceof i))a=$("<div />"),a.append(d),d=a;this.rootElm=d;return this};i.prototype.has_child=function(){return 0<this.num_child?!0:!1};i.prototype.install_callback=function(d){var a=this;d.click(function(){a.callback.click()})};
i.prototype.count_childs=function(){var d=0;for(c in this.entries)d++;return d};f.export(h,i)})(window,graphit,console);(function(j,f,i,h){function e(e){e=e||{};e.className=d;e.label="canvas";a.call(this,e,["width","height","bg_color","src"]);this.bg_color=this.bg_color||new k;(!this.width||0>this.width||1920<this.width)&&this.exception("invalid_width",this.width);(!this.height||0>this.height||1280<this.height)&&this.exception("invalid_height",this.height);this.data=document.createElement("canvas");this.data.setAttribute("width",this.width);this.data.setAttribute("height",this.height);this.ctx=this.data.getContext("2d");
this.clear(this.bg_color);this.src&&this.load(this.src)}var d="lib/canvas",a=f.import("lib/object"),k=f.import("lib/color");e.prototype=Object.create(a.prototype);e.prototype.constructor=new a;e.prototype.clone=function(){var a=new e({width:this.width,height:this.height,bg_color:this.bg_color});a.copy({src:this});return a};e.prototype.get_width=function(){return this.data.width};e.prototype.get_height=function(){return this.data.height};e.prototype.getImageData=function(a,d,e,f){return this.data.getContext("2d").getImageData(a,
d,e,f)};e.prototype.copy=function(a){!a.src&&(!(a.src instanceof e)||!(a.src instanceof Cimage))&&this.exception("invalid_copy_source");var d=null,f,k,j,q=null;f=this.get_width();k=this.get_height();a.src instanceof e?(d=a.src.data,j=a.src.get_width(),q=a.src.get_height()):(d=a.src,j=d.width,q=d.height,i.log("sw, dw",j,q));a.resize=a.resize!=h?a.resize:!1;var s=this.data.getContext("2d");s.save();"undefined"!=a.resize&&a.resize?s.drawImage(d,0,0,j,q,0,0,f,k):a.keepRatio?(d=this.data.width,k=a.src.get_width()/
a.src.get_height()/d,k*=this.data.height,s.drawImage(a.src.data,0,0,a.src.get_width(),a.src.get_height(),0,0,d,k)):(a=j>f?f:j,q=q>k?k:q,f=f>a?(f-a)/2:0,k=k>q?(k-q)/2:0,f=k=0,s.drawImage(d,0,0,a,q,f,k,a,q));s.restore()};e.prototype.get_pixel_color=function(a,d,e,f){return a.data[d*4*a.width+4*e+f]};e.prototype.getCanvas=function(){return this.data};a.prototype.getContext=function(a){a=a||"2d";if("data"in this)return this.data.getContext(a);i.error("Cannot return context for this object... no cCanvas");
return null};e.prototype.clear=function(a){var a=a||new k,d=this.getContext();0==a.a?d.clearRect(0,0,this.data.width,this.data.height):(d.save(),d.fillStyle=a.to_rgba(),d.fillRect(0,0,this.data.width,this.data.height),d.restore())};e.prototype.save=function(){var a=this.data.toDataURL("image/png");j.open(a)||(document.location.href=a)};e.prototype.load=function(a){var d=this;this.image_loading=new Cimage({src:a,callback_onload:function(){i.log("Image loaded",this);var a=cMath.clamp(1,this.rootElm.width,
d.data.width),e=cMath.clamp(1,this.rootElm.height,d.data.height);d.data.getContext("2d").drawImage(this.rootElm,0,0,a,e);d.image_loading=null},callback_onerror:function(){i.log("Failed to load image",this);d.image_loading=null}})};e.prototype.dom_build=function(){this.rootElm=this.data;return this};f.export(d,e)})(window,graphit,console);(function(j,f,i){function h(d){d=d||{};d.className="Module";d.label="Module";d.position=d.position||new Cpoint({x:0,y:0});d.width=d.width||0;d.height=d.height||0;e.call(this,d,["position","width","height"])}var e=f.import("lib/object");h.prototype=Object.create(e.prototype);h.prototype.constructor=new e;h.prototype.add_point=function(d){var a=d.x-this.position.x;a>this.width&&(this.width=a);d=d.y-this.position.y;d>this.height&&(this.height=d);i.log("Bounding",this)};f.export("lib/bounding/rectangle",
h)})(window,graphit,console);(function(j,f,i,h){j=function(e){if(e!=h&&(!("x"in e)||!("y"in e)))throw new Cexception_message({className:"lib/math/point2d",error:"invalid_component",additional:e});e=e||{x:0,y:0};Object.defineProperty(this,"x",{value:e.x,writable:!0,enumerable:!0,configurable:!1});Object.defineProperty(this,"y",{value:e.y,writable:!0,enumerable:!0,configurable:!1})};j.prototype.round=function(){this.x=Math.round(this.x);this.y=Math.round(this.y)};f.export("lib/math/point2d",j)})(window,graphit,console);(function(j,f){function i(d){this.className=h;e.call(this,d)}var h="lib/math/vector2d",e=f.import("lib/math/point2d");i.prototype=Object.create(e.prototype);i.prototype.constructor=new e;i.prototype.magnitude=function(){return 0==this.x&&0==this.y?0:Math.sqrt(this.x*this.x+this.y*this.y)};i.prototype.normalize=function(){var d=this.magnitude();if(0==d)return this;this.x/=d;this.y/=d;return this};i.prototype.from_point=function(d,a){this.x=a.x-d.x;this.y=a.y-d.y;return this};i.prototype.smul=function(d){this.x*=
d;this.y*=d;return this};i.prototype.vadd=function(d){this.x+=d.x;this.y+=d.y;return this};i.prototype.clone=function(){return new i(this)};f.export(h,i)})(window,graphit,console);(function(j,f,i,h){var e=function(d){this.className="lib/math/matrix33";m11=0;m12=1;m13=2;m21=3;m22=4;m23=5;m31=6;m32=7;m33=8;this.data=[];d=d!=h?d:[1,0,0,0,1,0,0,0,1];this.set(d)};e.prototype.init=function(){};e.prototype.clone=function(){return new e(this)};e.prototype._is_valid_array=function(d){return 9==d.length?!0:!1};e.prototype.translate=function(d){d=new e([1,0,0,0,1,0,d.x,d.y,1]);this.mul(d);return this};e.prototype.scale=function(d){d=new e([d.x,0,0,0,d.y,0,0,0,1]);this.mul(d);return this};
e.prototype.rotate=function(d){var a=Math.cos(d),d=Math.sin(d),a=new e([a,d,0,-d,a,0,0,0,1]);this.mul(a);return this};e.prototype.set=function(d){i.log(d);if(d==h)return this;if(d instanceof Array){if(!this._is_valid_array(d))throw"matrix33_invalid_array";for(var a=0;a<=m33;a++)this.data[a]=d[a]}else if(d instanceof e)for(a=0;a<=m33;a++)this.data[a]=d.data[a];else if("number"==typeof d){d=parseFloat(d);for(a=0;a<=m33;a++)this.data[a]=d}else throw"matrix33_invalid_value";return this};e.prototype.add=
function(d){if(!d)return this;if(d instanceof Array){if(!this._is_valid_array(d))throw"matrix33_invalid_array";for(var a=0;a<=m33;a++)this.data[a]+=d[a]}else if(d instanceof e)for(a=0;a<=m33;a++)this.data[a]+=d.data[a];else if("number"==typeof d){d=parseFloat(d);for(a=0;a<=m33;a++)this.data[a]+=d}else throw"matrix33_invalid_value";return this};e.prototype.round=function(){for(var d=0;d<=m33;d++)this.data[d]=Math.round(this.data[d]);return this};e.prototype.floor=function(){for(var d=0;d<=m33;d++)this.data[d]=
Math.floor(this.data[d]);return this};e.prototype.random=function(d){for(var d=d||1,a=0;a<=m33;a++)this.data[a]=Math.random(d);return this};e.prototype.identity=function(){this.data=[1,0,0,0,1,0,0,0,1];return this};e.prototype.mul=function(d){i.log(d);if(!d)return this;if(d instanceof e||d instanceof Array&&9==d.length){var a=this.data,f=[],h=null,h=d instanceof e?d.data:d;i.log(a,h);f[m11]=a[m11]*h[m11]+a[m12]*h[m21]+a[m13]*h[m31];f[m12]=a[m11]*h[m12]+a[m12]*h[m22]+a[m13]*h[m32];f[m13]=a[m11]*h[m13]+
a[m12]*h[m23]+a[m13]*h[m33];f[m21]=a[m21]*h[m11]+a[m22]*h[m21]+a[m23]*h[m31];f[m22]=a[m21]*h[m12]+a[m22]*h[m22]+a[m23]*h[m32];f[m23]=a[m21]*h[m13]+a[m22]*h[m23]+a[m23]*h[m33];f[m31]=a[m31]*h[m11]+a[m32]*h[m21]+a[m33]*h[m31];f[m32]=a[m31]*h[m12]+a[m32]*h[m22]+a[m33]*h[m32];f[m33]=a[m31]*h[m13]+a[m32]*h[m23]+a[m33]*h[m33];i.log("m",f);this.data=f}else if("number"==typeof d){i.log(typeof d);d=parseFloat(d);for(a=0;a<=m33;a++)this.data[a]*=d}else throw"matrix33_invalid_value";return this};e.prototype.minor=
function(){var d=[],a=this.data;d[m11]=a[m22]*a[m33]-a[m32]*a[m23];d[m12]=a[m21]*a[m33]-a[m31]*a[m23];d[m13]=a[m21]*a[m32]-a[m31]*a[m22];d[m21]=a[m12]*a[m33]-a[m32]*a[m13];d[m22]=a[m11]*a[m33]-a[m31]*a[m13];d[m23]=a[m11]*a[m32]-a[m31]*a[m12];d[m31]=a[m12]*a[m23]-a[m22]*a[m13];d[m32]=a[m11]*a[m23]-a[m21]*a[m13];d[m33]=a[m11]*a[m22]-a[m21]*a[m12];this.data=d;return this};e.prototype.to_s=function(d){var a="\n";d&&("format"in d&&"html"==d.format)&&(a="<br>\n");for(var d="Module"+a+" ",e=0;e<=m33;e++)d+=
this.data[e]+",",0==(e+1)%3&&(d+=a+" ");return d};f.export("lib/math/matrix33",e)})(window,graphit,console);(function(){var j=graphit.import("lib/math/vector2d"),f=graphit.import("lib/math/point2d");graphit.export("lib/math",{className:"lib/math",distance:function(f,h){var e=h.x-f.x,d=h.y-f.y;return Math.sqrt(e*e)+d*d},isint:function(f){return"number"===typeof f&&0==f%1},linear_interpolation:function(i,h,e){var e=1,d=[],a=new j;a.from_point(i,h);var k=a.magnitude();if(0==k)return d;a.normalize();var l=i.clone();a.smul(e);d.push(i);for(i=0;i<=k;i+=e)l.vadd(a),d.push(new f(l));d.push(h);return d},clamp:function(f,
h,e){return f<h?h:f>e?e:f}})})(window,graphit,console);(function(j,f){function i(e){e=e||{};e.className="Ctransform2d";e.label="Ctransform2d";h.call(this,e,[]);this.matrix=new Cmatrix33;this.matrix.identity();this.position=new Cvector2d;this.u=new Cvector2d;this.v=new Cvector2d}var h=f.import("lib/object");i.prototype=Object.create(h.prototype);i.prototype.constructor=new h;i.prototype.translate=function(e){(!("x"in e)||!1 in e)&&this.exception("camel_camouflage_failed");this.matrix.translate(e)};i.prototype.rotate=function(e){(!("x"in e)||!1 in e)&&
this.exception("camel_camouflage_failed");this.matrix.translate(e)};i.prototype.translate=function(e){e||this.exception("camel_camouflage_failed");this.matrix.translate(point)};f.export("Ctransform2d",i)})(window,graphit,console);(function(j,f,i,h){function e(a,d){this.min=a;this.max=d;this.last=null}function d(a){l.call(this,a);this.time=Date.now()}function a(a){a.className="Cmouse_tracker";a.label="mousetracker";k.call(this,a,["parent","callback_move","callback_track"]);this.y=this.x=0;this.cMinmaxX=new e(0,this.parent.width);this.cMinmaxY=new e(0,this.parent.height);this.minmax=Object({minx:0,maxx:this.parent.width,miny:0,maxy:this.parent.height});this.minx=this.minmax.maxx;this.maxx=0;this.miny=this.minmax.maxy;this.maxy=
0;this.pushed=null;this.paused=!1;this.interval=null;this.points=[];this.rootElm=null;return this}var k=f.import("lib/object"),l=f.import("lib/math/vector2d"),n=f.import("lib/math");e.prototype.init=function(a){this.min=this.max=this.last=a};e.prototype.cmp=function(a){if(a==h)return i.warn("MinMax: Comparing with null value"),!1;a<this.min&&(this.min=a);a>max&&(this.max=a);this.last=a;return!0};d.prototype=Object.create(l.prototype);d.prototype.constructor=new l({x:0,y:0});a.prototype=Object.create(k.prototype);
a.prototype.constructor=new k;a.prototype.reset=function(){this.minx=this.minmax.maxx;this.maxx=0;this.miny=this.minmax.maxy;this.maxy=0;this.points=[]};a.prototype.move=function(a,d){a=n.clamp(Math.round(a),this.minmax.minx,this.minmax.maxx);d=n.clamp(Math.round(d),this.minmax.miny,this.minmax.maxy);this.x=a;this.y=d;var e=this.callback_exists("track");e&&e.call(this,a,d);return this};a.prototype.push=function(){this.pushed=Date.now();var a=this;this.interval=setInterval(function(){if(!a.is_pushed())return clearInterval(a.interval),
null;if(this.paused)return null;var e=new d(a);a.points.push(e);a.minx=Math.min(a.minx,e.x);a.maxx=Math.max(a.maxx,e.x);a.miny=Math.min(a.miny,e.y);a.maxy=Math.max(a.maxy,e.y)},1E3/120);this.func_push&&this.func_push(this)};a.prototype.dom_build=function(){var a=$("<div />");a.attr("title","Mouse tracker");a.addClass("mousetracker");var d=document.createElement("div"),d=$(d);d.addClass("ui-widget-content");d.append('<div class="hold-var"><h6>x:&nbsp;</h6><span class="var-x">'+this.x+"</span></div>");
d.append('<div class="hold-var"><h6>y:&nbsp;</h6><span class="var-y">'+this.y+"</span></div>");a.append(d);this.rootElm=a;return this};a.prototype.release=function(){this.pushed=null;this.func_release&&this.func_release(this);this.reset()};a.prototype.is_pushed=function(){return this.pushed};a.prototype.to_s=function(){return"Cmouse_tracker: "+this.x+" / "+this.y};f.export("lib/mouse/tracker",a)})(window,graphit,console);(function(j,f){function i(a,e){d.call(this);this.label=e;this.parent=a;this.dom=null}function h(a,d){i.call(this,a,d)}function e(a,d){i.call(this,a,d);this.wHeader=new h(this,d)}var d=f.import("lib/object");i.prototype=Object.create(d.prototype);i.prototype.constructor=new d;i.prototype.dom_get=function(a){return this.dom&&!a?this.dom:this.dom_build().dom};h.prototype=Object.create(i.prototype);h.prototype.constructor=new i;h.prototype.dom_build=function(){var a=$(document.createElement("div"));a.addClass("window-header");
a.append(this.label);this.dom=a;return this};e.prototype=Object.create(i.prototype);e.prototype.constructor=new i;e.prototype.dom_build=function(){var a=$(document.createElement("div"));a.addClass("widget-window");a.append(this.wHeader.dom_get());this.dom=a;return this};f.export("app/widget",e)})(window,graphit,console);(function(j,f){f.export("app/enum/compositeOperation",{"source-over":"source-over","source-in":"source-in","source-out":"source-out","source-atop":"source-atop",lighter:"lighter",xor:"xor","destination-over":"destination-over","destination-in":"destination-in","destination-out":"destination-out","destination-atop":"destination-atop",darker:"darker"})})(window,graphit,console);(function(j,f,i){function h(a){var f=this,a=a||{};a.className=e;a.label=a.label||"tool";this.cCanvas=this.brush=null;this.need_update=!0;this.optElm=this.rootElm=null;this.changeCursor=!0;for(p in a.parameters)a.parameters[p].parent=this;d.call(this,a,"parent brush label _pregraph _graph _postgraph _update compositeOperation".split(" "));for(p in this.parameters)this.bind_trigger(this.parameters[p],"update",function(){f.update()});return this}var e="app/tool",d=f.import("lib/object"),a=f.import("lib/icon"),
k=f.import("lib/canvas"),l=new (f.import("lib/po"));h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.canvas_create=function(a,d){if(!a||0>a||1920<a)return i.error("Width not in range",a),null;if(!d||0>d||1080<d)return i.error("Height not in range",d),null;this.set_parameter("width",a);this.set_parameter("height",d)};h.prototype.set_options=function(a){if(!a.brush)return i.error("No brush in Module options"),!1};h.prototype.update=function(){this.need_update=!0;if(!this.need_update)return i.log("Doesn't need update"),
!1;var a=this.get_parameter("size");a||this.exception("no_size_parameter",this.label);this.cCanvas=new k({width:a,height:a});this.ctx=this.cCanvas.getContext("2d");a=this.parent.brush_manager.selected.cCanvas.data;this.ctx.drawImage(a,0,0,a.width,a.height,0,0,this.cCanvas.get_width(),this.cCanvas.get_height());this.need_update=!1;this.send_trigger("update")};h.prototype.drawImage=function(a,d,e){var f=a.getContext("2d"),h=this.cCanvas.canvas;if(!f)return i.error("Cannot acquire context"),!1;if(d>
a.width||0>d)return i.error("x not in canvas destination range",d),!1;if(e>a.height||0>e)return i.error("y not in canvas destination range",e),!1;f.drawImage(h,0,0,h.width,h.height,d,e,h.width,h.height);return!0};h.prototype.onclick=function(){"callback_onclick"in this.options&&"function"===typeof this.options.callback_onclick&&this.options.callback_onclick(this)};h.prototype.dom_build=function(a){if(this.rootElm&&!a)return this;a=$("<div />");a.append(this.dom_build_tool());this.rootElm=a;return this};
h.prototype.dom_build_tool=function(){var d=this,e="stock-tool-"+this.label;l.get("tool_"+this.label);e=new a({path:"tools",name:e,callback_click:function(){d.send_trigger("tool_selected",d)},label:void 0});return $(e.dom_get().addClass("group tool"))};h.prototype.dom_build_options=function(){if(this.optElm)return this.optElm;var a=$(document.createElement("div"));a.addClass("not-draggable");for(label in this.parameters)a.append(this.parameters[label].dom_get());return this.optElm=a};h.prototype.callback_click=
function(){this.parent&&this.parent.select_tool(this)};h.prototype.graph=function(){this.exceptions("method_must_be_overidden")};h.prototype.pre_graph=function(){};h.prototype.post_graph=function(){};f.export(e,h)})(window,graphit,console);(function(j,f){function i(a){a=a||{};a.className=h;a.label="pencil";a.parameters={size:{label:"size",min:1,max:100,def:20,step:1},opacity:{label:"opacity",min:0,max:1,def:1,step:0.01},linecap:{type:d.select,label:"linecap",choices:{round:"round",butt:"butt",square:"square"},def:"round"}};e.call(this,a,[])}var h="app/tool/pencil",e=f.import("app/tool"),d=f.import("lib/parameter/enum/type");i.prototype=Object.create(e.prototype);i.prototype.constructor=new e;i.prototype.graph=function(a){var d=a.cSurface.layer_manager.special_layers.prefrag.cCanvas.data.getContext("2d");
d.save();d.lineWidth=Math.round(this.parameters.size.value);var e=a.fgColor.color.clone();e.a=this.parameters.opacity.value;d.strokeStyle=e.to_rgba();d.lineCap=this.parameters.linecap.value;d.beginPath();d.moveTo(a.A.x,a.A.y);d.lineTo(a.B.x,a.B.y);d.stroke();d.closePath();d.restore();return!0};f.export(h,i)})(window,graphit,console);(function(j,f){function i(a){a=a||{};a.className=h;a.label="paintbrush";a.parameters={size:{label:"size",min:1,max:100,def:20,step:1},opacity:{label:"opacity",min:0,max:1,def:1,step:0.01},pression:{label:"pression",min:0.1,max:100,def:100,step:0.01}};e.call(this,a,[])}var h="app/tool/paintbrush",e=f.import("app/tool"),d=f.import("lib/math");i.prototype=Object.create(e.prototype);i.prototype.constructor=new e;i.prototype.graph=function(a){var e=a.cSurface.layer_manager.special_layers.prefrag.cCanvas.data.getContext("2d"),
f=this.cCanvas.data,h=f.width/2,i=f.height/2,j=this.get_parameter("pression"),a=d.linear_interpolation(a.A,a.B,100/j);if(0>=a.length)return!1;for(j=0;j<a.length;j++)e.save(),a[j].round(),e.translate(a[j].x-h,a[j].y-i),e.drawImage(f,0,0,f.width,f.height),e.restore();return!0};f.export(h,i)})(window,graphit,console);(function(j,f){function i(a){a=a||{};a.className=h;a.label="eraser";a.compositeOperation=d.xor;a.parameters={size:{label:"size",min:1,max:100,def:20,step:1},pression:{label:"pression",min:0.1,max:100,def:100,step:0.01}};e.call(this,a,[])}var h="app/tool/eraser",e=f.import("app/tool"),d=f.import("app/enum/compositeOperation"),a=f.import("lib/math");i.prototype=Object.create(e.prototype);i.prototype.constructor=new e;i.prototype.pre_graph=function(a){var d=a.cSurface.layer_manager.special_layers.prefrag.cCanvas.data.getContext("2d"),
a=a.cSurface.layer_manager,e;a.special_layers.stack_down&&(e=a.special_layers.stack_down.cCanvas.data,d.drawImage(e,0,0,e.width,e.height));e=a.selected.cCanvas.data;d.drawImage(e,0,0,e.width,e.height)};i.prototype.post_graph=function(a,d,e,f,h){var i=a.cSurface.layer_manager.selected,a=a.cSurface.layer_manager.special_layers.prefrag,j=a.clone(),s=j.cCanvas.getContext("2d");s.save();s.clearRect(0,0,j.cCanvas.data.width,j.cCanvas.data.height);s.globalCompositeOption="xor";s.drawImage(a.cCanvas.data,
0,0,a.cCanvas.data.width,a.cCanvas.data.height);i.drawImage(j.cCanvas.data,d,e,f,h,0,0,"source-in");s.restore()};i.prototype.graph=function(e){var f=e.cSurface.layer_manager.special_layers.prefrag.cCanvas.data.getContext("2d");e.cSurface.layer_manager.special_layers.prefrag.down_composite_operation=d["source-in"];f.globalCompositeOperation=d["destination-out"];for(var h=this.cCanvas.data,i=h.width/2,j=h.height/2,r=this.get_parameter("pression")||100,e=a.linear_interpolation(e.A,e.B,100/r),r=0;r<e.length;r++)f.save(),
f.translate(e[r].x-i,e[r].y-j),f.drawImage(h,0,0,h.width,h.height),f.restore();f.restore();return!0};f.export(h,i)})(window,graphit,console);(function(j,f,i){function h(a){a=a||{};a.className=e;a.label="bucket-fill";a.parameters={size:{label:"size",min:1,max:100,def:20,step:1}};d.call(this,a,[])}var e="app/tool/fill",d=f.import("app/tool"),a=f.import("lib/image/analyse");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.graph=function(d){var e=d.cSurface.layer_manager.special_layers.prefrag.cCanvas.data.getContext("2d"),f=d.cSurface.layer_manager.get();if(!f)return i.error("No layer selected"),!1;for(var f=
f.getImageData(0,0,f.get_width(),f.get_height()),h=(new a).adjacent_by_color(f,d.A),j=d.cToolbox.fg_color.color,r=0;r<h.length;r++)if(1==h[r]){var q=4*r;f.data[q]=j.r;f.data[q+1]=j.g;f.data[q+2]=j.b;f.data[q+3]=255}d.cMouse.minx=0;d.cMouse.miny=0;d.cMouse.maxx=f.width;d.cMouse.maxy=f.height;e.putImageData(f,0,0);d.cGrapher.stop();return!0};f.export(e,h)})(window,graphit,console);(function(j,f,i){function h(f){f=f||{};f.className=e;f.label="color-picker";f.compositeOperation=a.xor;f.parameters={size:{label:"size",min:1,max:100,def:20,step:1}};d.call(this,f,[])}var e="app/tool/colorPicker",d=f.import("app/tool"),a=f.import("app/enum/compositeOperation"),k=f.import("lib/color");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.graph=function(a){var d=a.cSurface.layer_manager.get();d||this.exception("no_layer_selected");d=d.getImageData(0,0,d.get_width(),
d.get_height());d=(new k).from_pixel(d,a.A);i.log("Selected color",d.to_s());a.cToolbox.fg_color.color.set(d);a.cGrapher.stop();return!0};f.export(e,h)})(window,graphit,console);(function(j,f,i){function h(a){a=a||{};a.className="graphit/message";a.label="message";d.call(this,a,"cSurface cMouse cTool cToolbox points fgColor bgColor cGrapher index".split(" "))}function e(a){a=a||{};a.className="Module";a.label="grapher";d.call(this,a,["parent"])}var d=f.import("lib/object");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;f.export("graphit/message",h);e.prototype=Object.create(d.prototype);e.prototype.constructor=new d;e.prototype.init=function(){this.parent||
this.exception("no_parent_argument");this.reset_index();this.timer=null;this.mode=1};e.prototype.reset_index=function(){this.index=0};e.prototype._graph=function(a){var d=a.points.length;if(2>=d||this.index>=d-1)return!1;d=a.points[this.index+1];a.A=a.points[this.index];a.B=d;a.index=this.index;if(a.cTool.graph(a)&&(!this.last_redraw||Date.now()-this.last_redraw>1E3/60))this.last_redraw=Date.now(),a.cSurface.redraw(!0);this.index++};e.prototype.stop=function(){var a=f.import("app/layer");try{if(!this.timer)return i.warn("Grapher is not started"),
!1;clearInterval(this.timer);this.timer=null;var d=this.parent.selected,e=d.cMouse,j=d.layer_manager.selected,m=d.layer_manager.special_layers.prefrag,t=j.cCanvas.data,r=this.parent.cToolbox.selected,q=this.parent.cToolbox.selected.parameters.size.value,s=q/2,u=e.maxx-e.minx+q,x=e.maxy-e.miny+q,v=e.minx-s;0>v&&(v=0);v+u>t.width&&(u=t.width-v);var w=e.miny-s;0>w&&(w=0);w+x>t.height&&(x=t.height-w);var y=new h({cSurface:d,cMouse:d.cMouse});r.post_graph(y,v,w,u,x,0,0,u,x)||j.drawImage(m.cCanvas.data,
v,w,u,x,0,0);d.layer_manager.special_layers.prefrag=new a({parent:d.layer_manager,label:"_prefrag",width:d.get_width(),height:d.get_height()});this.index=0;return!0}catch(A){return i.error(A),!1}};e.prototype.start=function(){if(this.timer)return i.error("Grapher already started"),!1;var a=this;if(!this.parent.cToolbox||!this.parent.cToolbox.selected)return this.send_trigger("error","no-tool-selectionned"),i.error("No tool selectionned!"),!1;var d=this.parent,e=new h({cSurface:d.selected,cMouse:d.selected.cMouse,
cTool:d.cToolbox.selected,cToolbox:d.cToolbox,points:d.selected.cMouse.points,fgColor:d.cToolbox.fg_color,bgColor:d.cToolbox.bg_color,cGrapher:this,index:this.index});e.cTool.pre_graph(e);this.timer=j.setInterval(function(){a._graph(e)},5);return!0};e.prototype.__test=function(){i.log("Overide Cobject.__test");return!0};e.prototype.__test=e.prototype.__test;f.export("app/grapher",e)})(window,graphit,console);var cDraw={circle:function(j){var f=j.dcanvas.getContext("2d");if(!f)return console.error("Cannot aquiere context"),!1;f.save();f.beginPath();f.arc(j.x,j.y,j.r,0,2*Math.PI,!0);j.fillStyle&&(f.fillStyle=j.fillStyle.to_rgba(),f.fill());j.lineWidth&&(f.lineWidth=j.lineWidth);j.strokeStyle&&(f.strokeStyle=j.strokeStyle.clone().set("a",1).to_rgba(),f.stroke());f.closePath();f.restore();return!0}};(function(j,f,i){function h(){this.logo=j.graphit.baseStaticContent+"images/badge-gplv3-32.png";this.text="license-gpl3.txt";this.rootElm=null;this.dialog_options={width:400}}h.prototype.dom_build=function(){if(this.rootElm)return this;var e=$('<div title="License"/>');e.addClass("about ");var d=$("<div />");d.addClass("group-license");var a=$("<img />");a[0].src=this.logo;d.append(a);d.append('<p>Source code: <a href="#code" onclick="window.open(\'http://github.com/shojs/graphit/\'); return false;">github</a></p>');
d.append('<p>Documentation: <a href="#doc" onclick="window.open(\'http://github.com/shojs/graphit/wiki\');return false;">Wiki</a></p>');d.append('<p><img src="'+j.graphit.baseStaticContent+'images/gimp/stock-wilber-eek-64.png">&nbsp;All icons comes from the <a href="http://www.gimp.org">Gimp</a> project.</p>');d.append("<h6>License</h6>");a=$("<p />");a.addClass("text");a.append("                    GNU GENERAL PUBLIC LICENSE                       Version 3, 29 June 2007\n\n Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/> Everyone is permitted to copy and distribute verbatim copies of this license document, but changing it is not allowed.");
d.append(a);try{a.load(this.text)}catch(f){throw i.error("Cannot load full license",f),f;}a=document.createElement("button");$(a).append("Close");$(a).button();$(a).click(function(){e.dialog("close")});d.append(a);e.append(d);this.rootElm=e;return this};h.prototype.dom_get=function(){return this.dom_build().rootElm};f.export("app/license",h)})(window,graphit,console);(function(j,f,i){function h(f){f.className=e;f.label="frag";d.call(this,f,["parent","position","width","height","color"]);this.color||(this.color=new a);this.cCanvas=new k({width:this.width,height:this.height,bg_color:this.color});(!this.position||!(this.position instanceof l))&&this.exception("invalid_position")}var e="app/frag",d=f.import("lib/object"),a=f.import("lib/color"),k=f.import("lib/canvas"),l=f.import("lib/math/vector2d");h.prototype=Object.create(d.prototype);h.prototype.constructor=
new d;h.prototype.drawImage=function(a,d,e,f,h){var j=this.cCanvas.data,k=this.cCanvas.data.getContext("2d");try{k.drawImage(a,d,e,f,h,0,0,j.width,j.height)}catch(l){return i.error("Cannot draw to fragment",l),!1}return!0};f.export(e,h)})(window,graphit,console);(function(j,f,i,h){function e(e){e=e||{};e.className=d;e.label=e.label||"layer";e.position=e.position||new k({x:0,y:0});e.composite_operation=e.composite_operation||l["source-over"];e.visible=e.visible!=h?e.visible:!1;e.need_redraw=!0;a.call(this,e,"parent width height composite_operation need_redraw visible".split(" "))}var d="app/layer",a=f.import("lib/object"),k=f.import("lib/math/vector2d"),l=f.import("app/enum/compositeOperation"),n=f.import("lib/canvas"),m=f.import("lib/icon"),t=f.import("lib/image"),
r=f.import("app/frag");e.prototype=Object.create(a.prototype);e.prototype.constructor=new a;e.prototype.init=function(){var a=this;if(!this.width||0>this.width||1920<this.width)i.error("gabou",this),this.exception("invalid_width",this.width);(!this.height||0>this.height||1280<this.height)&&this.exception("invalid_height",this.height);this.frags=[];this.cCanvas=new n({width:this.width,height:this.height});this.bind_trigger(this,"redraw_preview",function(d){4<j.graphit.debug&&i.debug("[Trigger/received]",
d.type);a.redraw_preview()})};e.prototype.get_width=function(){return this.cCanvas.get_width()};e.prototype.get_height=function(){return this.cCanvas.get_height()};e.prototype.getImageData=function(a,d,e,f){return this.cCanvas.getImageData(a,d,e,f)};e.prototype.clone=function(){var a=this.cCanvas.data,d=new e({parent:this.parent,label:this.label,composite_operation:this.composite_operation,width:this.width,height:this.height});d.visible=this.visible;d.cCanvas.getContext().drawImage(a,0,0,a.width,
a.height);d.need_redraw=!1;d.rootElm=this.rootElm;return d};e.prototype.discard_frag=function(){this.need_redraw=!0;return this.frags.pop()};e.prototype.dom_get=function(){this.dom_build();return this.rootElm};e.prototype.set_visibility=function(a){this.visibility=a?!0:!1};e.prototype.toggle_visibility=function(){return!0==this.visibility?this.set_visibility(!1):this.set_visibility(!0)};e.prototype.dom_build=function(){if(this.rootElm)return this;var a=this,d=document.createElement("li"),e=$(d);e.attr("id",
this.uid);e.addClass("layer");d=$("<div/>");d.attr("id",this.uid);var f=$("<ul />");f.append('<li><a href="#'+this.guid(1)+'">layer</a></li>');f.append('<li><a href="#'+this.guid(2)+'">option</a></li>');f.append('<li><a href="#'+this.guid(3)+'">stats</a></li>');d.append(f);var f=$('<div id="'+this.guid(1)+'"/>'),h=new m({name:"stock-eye",size:20,callback_click:function(){a.toggle_visibility();a.send_trigger("update")}}),k=document.createElement("table"),k=$(k),l=$(document.createElement("tr")),n=
$(document.createElement("td"));n.append(h.dom_get());l.append(n);n=$(document.createElement("td"));h="<span>Layer - "+this.label+"</span>";n.css("width","100px");n.css("text-overflow","ellipsis");n.append(h);n.editInPlace({callback:function(d,e){return a.label=e}});n.addClass("label");l.append(n);n=$(document.createElement("td"));n.addClass("preview");this.canvas_preview=h=document.createElement("canvas");var r=100*(this.cCanvas.data.height/this.cCanvas.data.width);h.width=100;h.height=r;h=$(h);
n.click(function(){$(this).parents(".group-layers").find(".layer").removeClass("selected");$(this).parents(".layer").addClass("selected");a.parent.select(a)});n.append(h);l.append(n);n=$(document.createElement("td"));h=j.graphit.baseStaticContent+"/";r=new m({name:"stock-gravity-north",size:24,width:16,height:16,callback_click:function(){a.parent.move_up(a.uid)}});n.append(r.dom_get());r=new m({name:"stock-gravity-south",size:24,width:16,height:16,callback_click:function(){a.parent.move_down(a.uid)}});
n.append(r.dom_get());h=new t({src:h+"images/16x16_trash.png",width:16,height:16,callback_click:function(){$(this).parents("li.layer")?(e.remove(),a.parent.remove(a)):i.error("Cannot remove layer element")}});l.append(n);n=$(document.createElement("td"));n.addClass("options");n.append(h.dom_get());l.append(n);k.append(l);f.append(k);d.append(f);f=$('<div id="'+this.guid(2)+'"/>');f.append("<p>Layer option</p>");d.append(f);var z=$('<div id="'+this.guid(3)+'"/>');z.append('<p>Total fragment: <span id="'+
this.guid("total-fragment")+'">'+this.frags.length+"</span></p>");this.bind_trigger(this,"redraw_preview",function(){z.find("span").empty().append(a.frags.length)});d.append(z);e.append(d);d.tabs();this.rootElm=e;return this};e.prototype.redraw_preview=function(){var a=this.canvas_preview.getContext("2d"),d=this.cCanvas.data;a.clearRect(0,0,d.width,d.height);a.drawImage(d,0,0,d.width,d.height,0,0,this.canvas_preview.width,this.canvas_preview.height)};e.prototype.redraw=function(a){"boolean"===typeof a&&
(this.need_redraw=a);if(!this.need_redraw)return!1;a=this.cCanvas.getContext();a.clearRect(0,0,this.cCanvas.data.width,this.cCanvas.data.height);"compositeOperation"in this&&(a.compositeOperation=this.compositeOperation);for(var d=this.cCanvas.data.width,e=this.cCanvas.data.height,f=0;f<this.frags.length;f++){var h=this.frags[f],i=h.cCanvas.data,j=i.height,m=i.width,k=h.position.x;0>k?k=0:k+m>d&&(m=d-k);var l=h.position.y;0>l?l=0:l+j>e&&(j=e-l);a.save();a.beginPath();a.rect(k,l,m,j);a.clip();a.globalCompositeOperation=
h.downCompositeOperation?h.downCompositeOperation:"source-over";a.drawImage(i,0,0,m,j,k,l,m,j);a.restore()}this.send_trigger("redraw_preview");this.need_redraw=!1;return!0};e.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.frags=[]};e.prototype.drawImage=function(a,d,e,f,h,i,j,m){i=new r({parent:this,position:new k({x:d,y:e}),width:f,height:h});i.drawImage(a,d,e,f,h,0,0);this.frags.push(i);m&&(i.downCompositeOperation=m)};e.prototype.copy=function(a){this.drawImage(a.src,
0,0,a.src.width,a.src.height,0,0)};e.prototype.to_json=function(){return{label:this.data,data:this.cCanvas.data.toDataURL()}};f.export("app/layer",e)})(window,graphit,console);(function(j,f,i,h){function e(e){var f=this,e=e||{};e.className=d;e.label="layermanager";a.call(this,e,["parent"]);this.parent||this.exception("no_parent_parameter");this.layers=[];this.special_layers={};this.selected=null;this.dom_build();this.bind_trigger(this,"update",function(){f.redraw()});var e=this.parent.get_width(),h=this.parent.get_height();this.add(new l({parent:this,label:"_stack_up",width:e,height:h}));this.add(new l({parent:this,label:"_stack_down",width:e,height:h}));this.add(new l({parent:this,
label:"_grid",width:e,height:h}));this.add(new l({parent:this,label:"background",width:e,height:h}))}var d="app/layer/manager",a=f.import("lib/object"),k=f.import("lib/icon"),l=f.import("app/layer"),n=f.import("lib/math");e.prototype=Object.create(a.prototype);e.prototype.constructor=new a;e.prototype.build_layer_stack=function(a){this.special_layers.stack_down=this.layer_stack(0,a-1);this.special_layers.stack_up=this.layer_stack(a+1,this.layers.length-1)};e.prototype.add=function(a){a.parent=this;
var d=this;if(!(a instanceof l))return i.error("Layer manager need Clayer object"),null;var e=RegExp(/^_(.*)/).exec(a.label);e?(a.label="layer-"+e[1],this.special_layers[e[1]]=a):this.layers.push(a);if(!e&&this.rootElm){var e=this.rootElm.find(".group-layers"),f=$(a.dom_get(this.layers.length-1));e.prepend(f)}this.selected||(this.selected=a);this.bind_trigger(a,"update",function(){d.redraw()});this.send_trigger("update");return a};e.prototype.layer_stack=function(a,d){if(a>d)return null;for(var e=
this.parent.get_width(),f=this.parent.get_height(),e=new l({parent:this,label:"stack",width:e,height:f}),f=e.cCanvas.getContext(),h,i=a;i<=d;i++)h=this.layers[i].cCanvas.data,f.drawImage(h,0,0,h.width,h.height);return e};e.prototype.exists=function(a){for(var d=0,e=!1,d=0;d<this.layers.length;d++)if(this.layers[d]==a){e=!0;break}return e?d:null};e.prototype.remove=function(a){var d=this.selected,e=this.exists(a);d==a&&1<e&&(d=this.layers[e-1]);e===h&&i.error("Cannot remove undefined element");this.layers.splice(e,
1);this.select(d);this.parent.redraw(!0)};e.prototype.get=function(a){return!a||"__selected__"==a?this.selected:n.isint(a)?this.layers[a]:this.special_layers[a]};e.prototype.get_index_by_uid=function(a){for(var d=0;d<this.layers.length;d++)if(this.layers[d].uid==a)return d;return null};e.prototype.move_down=function(a){a=this.get_index_by_uid(a);if(a===h||1>=this.layers.length||1>a)return i.error("Can't move layer up"),!1;var d=this.layers[a-1];this.layers[a-1]=this.layers[a];this.layers[a]=d;this.select(this.selected);
this._build_layer_preview(".group-layers");this.send_trigger("update");return!0};e.prototype.move_up=function(a){if(1==this.layers.length)return!1;a=this.get_index_by_uid(a);if(a===h||a>=this.layers.length-1||1>=this.layers.length)return i.error("Can't move layer up"),!1;var d=this.layers[a+1];this.layers[a+1]=this.layers[a];this.layers[a]=d;this.select(this.selected);this._build_layer_preview(".group-layers");this.send_trigger("update");return!0};e.prototype.select=function(a){a=this.exists(a);if(a===
h||0>a||a>this.layers.length)return i.error("Layer index out of range: "+a),!1;this.build_layer_stack(a);this.selected=this.layers[a];this.send_trigger("update");return!0};e.prototype.dom_build=function(){var a=this,d=$("<div />");d.attr("title","Layer manager");var e=$("<div />");$("<div />");var f=new k({name:"stock-layer",size:24,width:16,height:16,title:"Create new layer",callback_click:function(){a.add(new l({parent:a,width:a.parent.get_width(),height:a.parent.get_height()}))}});d.append(f.dom_get());
f=$("<ul />");f.addClass("group-layers ui-widget-content");d.append(f);d.append(e);this.rootElm=d;return this};e.prototype._build_layer_preview=function(a){a=$(a);a.find(".layer").detach();for(var d=this.layers.length-1;0<=d;d--)this.layers[d].redraw(!0),a.append(this.layers[d].dom_get(1))};e.prototype.dom_exists=function(a){var d=!1,e;for(e=0;e<this.layers.length;e++)if(this.layers[e].rootElm=a){d=!0;break}return d?e:null};e.prototype.redraw=function(a){for(var d=0;d<this.layers.length;d++)this.layers[d].redraw(a)};
f.export(d,e)})(window,graphit,console);(function(j,f){function i(a){a.className=h;a.label="grid";e.call(this,a,["parent","callback_slide","callback_change","label"])}var h="app/grid",e=f.import("lib/object"),d=f.import("lib/color"),a=f.import("lib/parameter/numeric"),k=f.import("lib/parameter/checkbox"),l=f.import("lib/parameter/enum/type");i.prototype=Object.create(e.prototype);i.prototype.constructor=new e;i.prototype.init=function(){this.color=this.color||new d({a:1});this.isVisible=this.isVisible||!0;var e=this,f=function(){e.send_trigger("update")};
this.parameters={width:new a({parent:this,label:"width",min:1,max:100,def:100,step:1,callback_change:f,callback_slide:f}),height:new a({parent:this,label:"height",min:1,max:100,def:100,step:1,callback_change:f,callback_slide:f}),lineWidth:new a({parent:this,label:"lineWidth",min:1,max:10,def:1,step:1,callback_change:f,callback_slide:f}),visibility:new k({parent:this,type:l.checkbox,label:"visibility",def:!1,callback_change:f})};this.label="grid";this.rootElm=null};i.prototype.draw=function(a,d,e,
f,h){d=a.getContext("2d");d.save();d.beginPath();f=this.get_parameter("width");h=this.get_parameter("height");for(e=f+1;e<a.width;e+=f)d.moveTo(e,0),d.lineTo(e,a.height);for(f=h+1;f<a.height;f+=h)d.moveTo(0,f),d.lineTo(a.width,f);d.closePath();d.strokeStyle=this.color.to_rgba();d.lineWidth=this.get_parameter("lineWidth");d.stroke();d.restore()};i.prototype.dom_build=function(){var a=$("<div />");a.attr("title",this.label);a.addClass("grid");var d=$("<div />");d.addClass("ui-widget-content");for(label in this.parameters)a.append(this.parameters[label].dom_get());
a.append(d);this.rootElm=a;return this};f.export(h,i)})(window,graphit,console);(function(j,f,i,h){function e(e){var f=this,e=e||{};e.className=d;e.label="surface";e.parameters={zoom:{label:"zoom",min:-100,max:100,def:0,step:1,autoSave:!1,callback_slide:function(){i.log("sliding",this)}}};a.call(this,e,["width","height","label"]);e=this.width||0;e=k.clamp(1,e,1920);this.width!=e&&this.exception("invalid_width",this.width);e=this.height||0;e=k.clamp(1,this.height,1920);this.height!=e&&this.exception("invalid_height",this.height);this.need_redraw=!1;this.cCanvas=new l({width:this.width,
height:this.height});this.cCanvas.clear(new n);this.layer_manager=new m({parent:this});this.layer_manager.add(new t({parent:this.layer_manager,label:E_LAYERLABEL.mouse,width:this.width,height:this.height}));this.layer_manager.add(new t({parent:this.layer_manager,label:E_LAYERLABEL.prefrag,width:this.width,height:this.height}));this.layer_manager.add(new t({parent:this.layer_manager,width:this.width,height:this.height}));this.layer_manager.select(this.layer_manager.layers[0]);this.bind_trigger(this.layer_manager,
"update",function(a){4<j.graphit.debug&&i.log("[Trigger/received]",a.type);f.redraw(1)});this.cMouse=new r({parent:this,callback_move:function(){i.log("mouse move")},callback_track:function(a,d){$(f.cMouse.rootElm).find(".var-x").empty().append(a);$(f.cMouse.rootElm).find(".var-y").empty().append(d)}});this.cGrid=new q({parent:this,callback_slide:function(a){this.set(a);i.log("slide");this.send_trigger("update")},callback_change:function(a){this.set(a);i.log("Change");this.send_trigger("update")}});
this.bind_trigger(this.cGrid,"update",function(a){4<j.graphit.debug&&i.log("[Trigger/received]",a.type);f.update_grid()});this.bind_trigger(this,"update",function(){f.redraw(1)});this.bind_trigger(this,"show",function(a,d){d||widget_factory(f.dom_get(),{width:f.cCanvas.get_width()+100,zIndex:0,stack:!0}).show()});this.update_grid();return this}var d="app/surface",a=f.import("lib/object"),k=f.import("lib/math"),l=f.import("lib/canvas"),n=f.import("lib/color"),m=f.import("app/layer/manager"),t=f.import("app/layer"),
r=f.import("lib/mouse/tracker"),q=f.import("app/grid");e.prototype=Object.create(a.prototype);e.prototype.constructor=new a;e.prototype.set_current_layer=function(a){this.layer_manager.select(a)};e.prototype.update_grid=function(){var a=this.layer_manager.get("grid");a.cCanvas.getContext().clearRect(0,0,a.cCanvas.data.width,a.cCanvas.data.height);this.cGrid.get_parameter("visibility")&&this.cGrid.draw(a.cCanvas.data,0,0,this.cCanvas.data.width,this.cCanvas.data.height);this.need_redraw=!0;this.send_trigger("update")};
e.prototype.dom_build=function(){var a=this,d=$('<div title="(Ctrl-z) Undo"/>');d.addClass("surface");var e=$("<div/>"),f=$(this.cCanvas.data);f.width=this.width;f.height=this.height;f.addClass("canvas");f.attr("tabindex",0);f.mousedown(function(d){a.callback_mousedown(d,a)});f.mouseup(function(d){a.callback_mouseup(d,a)});f.mousemove(function(d){a.callback_mousemove(d,a)});f.mouseout(function(){a.cMouse.is_pushed()&&(a.cMouse.paused=!0)});f.mouseover(function(){a.cMouse.is_pushed()&&(a.cMouse.paused=
!1)});f.mouseenter(function(){a.send_trigger("surface_selected",a)});e.append(f);d.append(e);d.append(e);this.rootElm=d;return this};e.prototype.undo=function(){this.layer_manager.selected.discard_frag();this.layer_manager.selected.redraw();this.redraw(!0)};e.prototype.redraw=function(a){if(!this.need_redraw&&!a)return!1;if(!this.layer_manager.get())return i.warn("No layer selected"),!1;var d=this.cCanvas.data,e=d.getContext("2d");e.save();var f=this.get_parameter("zoom");0!=f&&(e.translate(d.width/
2,d.height/2),e.scale(f,f));e.clearRect(0,0,d.width,d.height);this.layer_manager.special_layers.stack_down!=h&&e.drawImage(this.layer_manager.special_layers.stack_down.cCanvas.data,0,0,d.width,d.height);this.layer_manager.selected.redraw(a);e.drawImage(this.layer_manager.selected.cCanvas.data,0,0,d.width,d.height);"down_composite_operation"in this.layer_manager.special_layers.prefrag&&(e.globalCompositeOperation=this.layer_manager.special_layers.prefrag.down_composite_operation);e.drawImage(this.layer_manager.special_layers.prefrag.cCanvas.data,
0,0,d.width,d.height);"down_composite_operation"in this.layer_manager.special_layers.prefrag&&(e.globalCompositeOperation="source-over");this.layer_manager.special_layers.stack_up!=h&&e.drawImage(this.layer_manager.special_layers.stack_up.cCanvas.data,0,0,d.width,d.height);"cGrid"in this&&this.cGrid.isVisible&&e.drawImage(this.layer_manager.special_layers.grid.cCanvas.data,0,0,d.width,d.height);e.restore();this.send_trigger("redraw_preview",this);this.need_redraw=!1;return!0};e.prototype.clear=function(){for(var a=
0;a<this.layer_manager.layers.length;a++)this.layer_manager.layers[a].clear();this.need_redraw=!0;this.send_trigger("update")};e.prototype.get_width=function(){return this.cCanvas.data.width};e.prototype.get_height=function(){return this.cCanvas.data.height};e.prototype.callback_mousedown=function(){if(this.cMouse.is_pushed())return i.warn("Mouse already pushed"),!1;this.cMouse.push();this.cGraphit.cGrapher.start();return!0};e.prototype.callback_mouseup=function(){if(!this.cMouse.is_pushed())return i.warn("Mouse not pushed"),
!1;this.cGraphit.cGrapher.stop();this.redraw(!0);this.cMouse.release();return!0};e.prototype.callback_mousemove=function(a,d){var e=$(d.cCanvas.data).offset();this.cMouse.move(a.pageX-e.left,a.pageY-e.top)};e.prototype.attach_graphit=function(a){var d=f.import("app/graphit");if(!a||!(a instanceof d))return i.error("Can't attach null or none Ctoolbox instance"),!1;this.cGraphit=a};e.prototype.save_as_json=function(){j.open(this.cCanvas.data.toDataURL());return data};f.export(d,e)})(window,graphit,
console);(function(j,f,i){function h(a){a=a||{};a.className=e;a.label="Workspace";d.call(this,a,[])}var e="app/surface/workspace",d=f.import("lib/object"),a=f.import("app/surface"),k=f.import("lib/icon"),l=new (f.import("lib/po"));h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.init=function(d){var e=this;try{this.cSurface=new a(d)}catch(f){throw i.error("Cannot create surface"),f;}this.bind_trigger(this,"show",function(){e.show()})};h.prototype.dom_build=function(){this.cSurface||
this.exception("surface_is_null");var a=this,d=$('<div class="graphit-workspace"/>'),e=$('<div class="navbar"/>');e.append((new k({name:"stock-layers",size:24,width:32,height:32,label:l.get("layers"),callback_click:function(){a.cSurface.layer_manager.dom_get().dialog({autoOpen:!0});return!1}})).dom_get());e.append((new k({name:"stock-image",size:24,width:32,height:32,label:l.get("save"),callback_click:function(){a.__save_dialog();return!1}})).dom_get());"auth"in j.graphit&&!j.graphit.auth.is_disable()&&
e.append((new k({path:"preferences",name:"folders",width:32,height:32,label:l.get("open"),callback_click:function(){a.__load_dialog();return!1}})).dom_get());d.append(e);d.append(this.cSurface.dom_get());e=$("<div />");d.append(e);this.rootElm=d;return this};h.prototype.__save_dialog=function(){$("<div />").attr("title","save");var a=this.cSurface.cCanvas.clone(),d=j.open(null,"graphit-save","resizable=yes, scrollbars=yes, titlebar=yes, width=300, height=300 top=10, left=10",!1),e=$(d.document.head);
0==e.find("title").length&&e.append("<title>GraphIt - "+l.get("save_image")+"</title>");var f=$('<link id="id-graphit-css" type="text/css" rel="stylesheet" href="css/style.css"/>');0==e.find("#id-graphit-css").length&&e.append(f);d=$(d.document.body);d.empty();e=$('<div class="graphit-window group" />');e.append("<h3>"+l.get("right_click_to_save")+"<h3/>");f=new $("<img />");f.attr("src",a.data.toDataURL());f.attr("width",200);f.attr("title","graphit-image");f.attr("alt","graphit-image");f.css("background-image",
'url("img/grid-40x40.png")');e.append(f);d.append(e)};h.prototype.__load_dialog=function(){var a=this;try{return this.get_widget("load").dialog("open")}catch(d){i.warn("Can't get <<load>> widget")}var e=$("<div />"),h=$('<input type="url" width="200" value="http://1.bp.blogspot.com/_cmrGYcwOHPE/TLXcloz0rFI/AAAAAAAAAas/Tv98tJD7qO0/s1600/plop1.gif"/>'),k=$("<button>"+l.get("load")+"</button>");k.click(function(){$(this).parent().dialog("close");var d=$(this).parent().find("input");loc=j.location;var e=
loc.pathname.split("/"),e=e.slice(0,e.length-1).join("/"),e=loc.protocol+"//"+loc.hostname+"/"+e+"php/DataURL/";i.log("server",e);try{f.auth.get("verifiedEmail"),$.getImageData({url:d.attr("value"),server:e,callback:"?",success:function(d){var e=new Clayer({width:a.cSurface.cCanvas.data.width,height:a.cSurface.cCanvas.data.height,label:"Web Image"});e.copy({src:d});a.cSurface.layer_manager.add(e)},error:function(e,f){i.error("Cannot load image",d.attr("value"));a.exception("cannot_load_image",f,{dialog:!0})}})}catch(h){widget_exception(h)}});
e.append(h);e.append(k);e.attr("title",l.get("load_image"));this.add_widget("load",e);e.dialog()};h.prototype.show=function(){this.dom_get()};f.export(e,h)})(window,graphit,console);(function(j,f,i){j=function(){var f={js:1,gbr:2},e;for(e in f)this[e]=f[e]};j.prototype.key_by_value=function(f){for(var e in this["enum"])if(this["enum"][e]==f)return e;return null};j.prototype.key_by_value=j.prototype.key_by_value;i.log("app/brush/enum/type",j);f.export("app/brush/enum/type",new j)})(window,graphit,console);(function(j,f,i){var h=f.import("lib/canvas"),e=f.import("lib/color");f.export("app/brush/tools",{circle:{width:100,height:100,callback_update:function(){var d=f.import("app/toolbox"),a=this.parent.parent;if(!(a instanceof d))return i.error("Brush parent of parent must be a toolbox"),!1;d=a.fg_color.color.clone();a=a.selected;"opacity"in a.parameters&&(d.a=a.parameters.opacity.value);a=this.cCanvas.data.width/2;this.cCursor=new h({width:this.cCanvas.width,height:this.cCanvas.height});cDraw.circle({dcanvas:this.cCursor.data,
x:a,y:a,r:a,fillStyle:new e({r:255,a:1}),strokeStyle:new e({r:255,a:1}),lineWidth:1});cDraw.circle({dcanvas:this.cCanvas.data,x:a,y:a,r:a,fillStyle:d})}},scircle:{width:100,height:100,callback_update:function(){var d=this.parent.parent;if(!(d instanceof Ctoolbox))return i.error("Brush parent of parent must be a toolbox"),!1;var a=d.fg_color.color.clone();if((d=d.selected)&&"opacity"in d.parameters)a.a=d.parameters.opacity.value;d=this.cCanvas.data.width/2;this.cCursor=new h({width:this.cCanvas.width,
height:this.cCanvas.height});cDraw.circle({dcanvas:this.cCursor.data,x:d,y:d,r:d,fillStyle:new e({r:255,a:1}),strokeStyle:new e({r:255,a:1}),lineWidth:1});cDraw.circle({dcanvas:this.cCanvas.data,x:d,y:d,r:d,strokeStyle:a})}},rectangle:{width:100,height:100,callback_update:function(){var d=this.parent.parent;if(!(d instanceof Ctoolbox))return i.error("Brush parent of parent must be a toolbox"),!1;var a=d.fg_color.color.clone();if((d=d.selected)&&"opacity"in d.parameters)a.a=d.parameters.opacity.value;
d=this.cCanvas.data.width;this.cCursor=new h({width:this.cCanvas.width,height:this.cCanvas.height});var e=this.cCursor.getContext();e.save();e.clearRect(0,0,d,d);e.strokeStyle=a.to_rgba();e.strokeRect(0,0,d,d);e.restore();e=this.cCanvas.getContext();e.save();e.clearRect(0,0,d,d);e.fillStyle=a.to_rgba();e.fillRect(0,0,d,d);e.restore()}}})})(window,graphit,console);(function(j,f,i){function h(a){a.className="Module";a.label="brush";e.call(this,a,["parent","name","type"])}var e=f.import("lib/object"),d=f.import("app/brush/enum/type"),a=f.import("lib/canvas"),k=f.import("lib/color");h.prototype=Object.create(e.prototype);h.prototype.constructor=new e;h.prototype.init=function(a){i.log("INITTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT");if(!this.type||!this.name)return i.error("Module need <<type>> and <<name>> parameter"),!1;if(this.type==d.js)this._load_js(a);else if(this.type==
d.gbr)i.log("Parsing Gimp Brush"),this._load_gbr(a);else return thix.exception("unknown_brush_type",this.type),!1;return this.init_canvas(a)};h.prototype.init_canvas=function(d){d=new a({width:d.data.width,height:d.data.height});d.clear(new k);this.cCanvas=d};h.prototype.update=function(){this.callback.update.call(this,this.parent)};h.prototype._load_js=function(a){if(!("callback_update"in a.data))return i.error("Javascript brush must contain a callback_update function"),!1;this.callback.update=a.data.callback_update;
return!("width"in a.data)||!("height"in a.data)?(i.error("Javascript brush need width and height property"),!1):!0};h.prototype._load_gbr=function(){};h.prototype.dom_build=function(){var a=this,e=$("<div />"),f=$("<div />");f.addClass("group-brush group");f.append("<label>"+d.key_by_value(this.type)+" / "+this.name+"</label>");i.log("Ccanvas",this.cCanvas);f.append(this.cCanvas.dom_get());e.append(f);e.click(function(){a.send_trigger("brush_selected",a);$(this).parents(".group-brushmanager").find(".group-brush").removeClass("selected");
$(this).children(".group-brush").addClass("selected")});this.rootElm=e;return this};f.export("app/brush",h)})(window,graphit,console);(function(j,f,i){function h(a){a=a||{};a.className=e;a.label="brushmanager";this.brushes=[];this.selected=null;d.call(this,a,["parent"])}var e="app/brush/manager",d=f.import("lib/object"),a=f.import("app/brush"),k=f.import("app/brush/enum/type"),l=f.import("app/brush/tools");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.init=function(){this.add(new a({parent:this,type:k.js,name:"circle",data:l.circle}));this.add(new a({parent:this,type:k.js,name:"rectangle",data:l.rectangle}));
this.add(new a({parent:this,type:k.js,name:"scircle",data:l.scircle}))};h.prototype.dom_build=function(){var a=this,d=$("<div />");d.attr("id",this.guid());d.attr("title",this.label);var e=$("<div />");cEach(this.brushes,function(d,f){var h=f.dom_get();a.selected==f&&h.find(".group-brush").addClass("selected");e.append(h)});d.append(e);this.rootElm=d;return this};h.prototype.add=function(d){var e=this;if(this.exists(d))return i.error("This brush is already present"),!1;this.selected||(this.selected=
d);this.bind_trigger(d,"brush_selected",function(d,f){if(!(f instanceof a))return i.error("Trigger brush_selected must reture a brush",d,f),!1;e.selected=f;e.selected.update();e.send_trigger("update")});this.brushes.push(d);this.send_trigger("update");return!0};h.prototype.exists=function(a){cEach(this.brushes,function(d){if(d.type==a.type&&d.name==a.name)return!0});return!1};f.export(e,h)})(window,graphit,console);(function(j,f,i){function h(a){var f=this;a.className=e;a.label="toolboxpreview";d.call(this,a,["parent"]);this.bind_trigger(this,"update",function(a){4<j.graphit.debug&&i.log("[Trigger/received]",a.type);a=f.parent.fg_color.color.clone().inverse();a.a=1;f.cCanvas.clear(a);a=f.cCanvas.getContext();f.cCanvas.clear();var d=f.parent.brush_manager.selected.cCanvas.data,e=f.parent.selected.get_parameter("size"),h=e>f.cCanvas.get_width()?f.cCanvas.get_width():e,k=e>f.cCanvas.get_height()?f.cCanvas.get_height():
e,e=(f.cCanvas.get_width()-e)/2;a.drawImage(d,0,0,d.width,d.height,e,e,h,k)})}var e="app/toolbox/preview",d=f.import("lib/object"),a=f.import("lib/canvas");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.init=function(){this.cCanvas=new a({parent:this,width:100,height:100})};h.prototype.dom_build=function(){var a=$("<div />");a.addClass("toolbox-preview");var d=$("<div />");d.append(this.cCanvas.dom_get());a.append(d);this.rootElm=a;return this};f.export(e,h)})(window,
graphit,console);(function(j,f,i){function h(f,h){var j=this;h.className=e;h.label=h.label||"toolbox_colorpicker";d.call(this,h,["parent","label","callback_onchange"]);if(f&&!(f instanceof a))return i.error("color parameter is not an instance of Ccolor"),null;this.color=f?f:new a;this.color.install_callback({name:"change",callback:function(){j.update()}});this.rootElm=null;this.cCanvas=new k({width:32,height:32});this.ctx=this.cCanvas.getContext();this.clear(this.color)}var e="app/toolbox/colorPicker",d=f.import("lib/object"),
a=f.import("lib/color"),k=f.import("lib/canvas");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.clear=function(a){this.cCanvas.clear(a)};h.prototype.to_rgba=function(){return this.color.to_rgba()};h.prototype.update=function(){this.clear(this.color);this.elmImage.getContext("2d").drawImage(this.cCanvas.data,0,0,this.cCanvas.get_width(),this.cCanvas.get_height());this.send_trigger("color_selected")};h.prototype.dom_build=function(){var a=this;if(this.rootElm)return this;
var d=document.createElement("div"),d=$(d),e=document.createElement("canvas");e.setAttribute("width",32);e.setAttribute("height",32);e.setAttribute("alt",this.label);e.setAttribute("title",this.label);this.elmImage=e;d.append(e);var f=e.getContext("2d"),h=this.cCanvas.data;f.drawImage(h,0,0,h.width,h.height);$(e).ColorPicker({onChange:function(d,e,f){a.color.set_rgb(f)},onSubmit:function(d,e,f){a.color.set_rgb(f)},zIndex:10});this.rootElm=d;return this};f.export(e,h)})(window,graphit,console);(function(j,f,i,h){function e(e){var f=this;e.className=d;e.label="toolbox";a.call(this,e,["parent"]);this.elmOptions=this.elmPreview=null;this.dialog_options={modal:!1,width:250,position:"right top",stack:!0};this.bind_trigger(this.fg_color,"color_selected",function(a){4<j.graphit.debug&&i.log("[Trigger/received]",a.type);f.update()});this.bind_trigger(this.bg_color,"color_selected",function(a){4<j.graphit.debug&&i.log("[Trigger/received]",a.type);f.update()});this.bind_trigger(this,"switch_color",
function(){f.switch_color()})}var d="app/toolbox",a=f.import("lib/object"),k=f.import("app/toolbox/preview"),l=f.import("app/toolbox/colorPicker"),n=f.import("app/tool"),m=f.import("app/tool/pencil"),t=f.import("app/tool/paintbrush"),r=f.import("app/tool/fill"),q=f.import("app/tool/eraser"),s=f.import("app/tool/colorPicker"),u=f.import("lib/color"),x=f.import("app/brush/manager"),v=f.import("lib/icon"),w=new (f.import("lib/po")),y=function(a){w.get(a)};e.prototype=Object.create(a.prototype);e.prototype.constructor=
new a;e.prototype.init=function(){var a=this;this.selected=null;this.tools=[];this.preview=new k({parent:this});this.fg_color=new l(new u({r:255,g:255,b:255,a:1}),{parent:this,callback_onchange:function(){this.send_trigger("update",a)},label:y("foreground_color")});this.bind_trigger(this.fg_color,"update",function(){a.update()});this.bg_color=new l(new u({r:0,g:0,b:0,a:1}),{parent:this,callback_onchange:function(){this.send_trigger("update",a)},label:y("background_color")});this.bind_trigger(this.bg_color,
"update",function(){a.update()});this.brush_manager=new x({parent:this});this.bind_trigger(this.brush_manager,"update",function(){a.update()});this.load(this.olist);this.dom_build()};e.prototype.select_tool_by_name=function(a){var d=this;return cEach(this.tools,function(e,f){f.label==a&&(d.select_tool(f),this.stop(),this.ret=!0);return!1})};e.prototype.load=function(){var a=this,d=function(d){a.bind_trigger(d,"update",function(){a.preview.send_trigger("update")});a.tools.push(d)},e=new m({parent:this});
d.call(this,e);this.selected=e;e=new t({parent:this});d.call(this,e);e=new q({parent:this});d.call(this,e);e=new r({parent:this});d.call(this,e);e=new s({parent:this});d.call(this,e)};e.prototype.update=function(){this.brush_manager.selected.callback.update.call(this.brush_manager.selected);this.selected.update();this.preview.send_trigger("update")};e.prototype.select_tool=function(a){if(a==h)return i.warn("Can't select undefined tool"),!1;var d=$(a.rootElm);d.parents(".group-tools").find(".tool").removeClass("selected");
d.children(".tool").addClass("selected");d=d.parents(".toolbox").find(".group-options");d.children("div").detach();d.append(a.dom_build_options());this.selected=a;this.update();return!0};e.prototype.switch_color=function(){var a=this.fg_color;this.fg_color=this.bg_color;this.bg_color=a;a=this.rootElm.find(".colorpicker-colors");a.children(".colorpicker").detach();this.dom_build_colorpickers(a);this.send_trigger("update_foreground_color")};e.prototype.dom_build_colorpickers=function(a){a.append(this.fg_color.dom_get());
a.append(this.bg_color.dom_get())};e.prototype.dom_build=function(){var a=this,d=$('<div title="Toolbox"/>');d.addClass("toolbox");var e=$("<div />");e.addClass("group group-tools ui-widget-content");for(var f=0;f<this.tools.length;f++){var h=this.tools[f];h.bind_trigger(h,"tool_selected",function(d,e){if(!(e instanceof n))return i.error("Trigger tool_selected must pass a Ctool argument"),!1;a.select_tool(e);return!0});var j=h.dom_get();this.selected==h&&h.rootElm.children(".tool").addClass("selected");
e.append(j)}d.append(e);e=$("<div/>");e.addClass("ui-widget-content group-colorpicker");f=$("<div/>");f.addClass("ui-widget-content colorpicker-colors");this.dom_build_colorpickers(f);e.append(f);e.append($((new v({name:"stock-default-colors",size:12,callback_click:function(){a.send_trigger("switch_color");a.update()},label:y("switch_color")})).dom_get().addClass("switch")));d.append(e);e=$("<div/>");e.addClass("group-preview ui-widget-content");e.append(this.preview.dom_get());d.append(e);e=$("<div />");
e.addClass("group-options ui-widget-content");d.append(e);e=$("<div />");e.addClass("group-brushmanager ui-widget-content");e.append(this.brush_manager.dom_get());d.append(e);this.rootElm=d;return this};f.export(d,e)})(window,graphit,console);(function(j,f,i){function h(a){a=a||{};a.className=e;a.label="binaryfile";this.headers=[];this.FH={};d.call(this,a,["src","callback_success","callback_error","responseType"]);this.responseType=this.responseType||"arraybuffer";this.response=null;this.loaded=!1;this.error="";this.src&&this.load(this.src)}var e="lib/binaryFile",d=f.import("lib/object");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.set_src=function(){};h.prototype.load=function(a){if(!a)return i.error("Trying to load undefined src"),
null;4<j.graphit.debug&&i.log("Loading file: "+a);this.src=a;var d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";var e=this;d.onload=function(){e.response=this;"success"in e.callback&&e.callback.success.call(e,this)};d.onerror=function(){i.error(this.className+" failed to load file",this.src);"error"in e.callback&&e.callback.error(e,this)};d.send()};h.prototype.header=function(a){return!(a in this.FH)?(i.error("No property <<",a,">> in header"),""):this.headers[this.FH[a]].value};
f.export(e,h)})(window,graphit,console);(function(j,f,i){function h(a){this.className=e;this.label="GBR file";d.call(this,a);"success"in this.callback&&(this.callback._success=this.callback.success);"error"in this.callback&&(this.callback._error=this.callback.error);this.callback.success=this._success;this.callback.error=this._error}var e="lib/binaryFile/GBR",d=f.import("lib/binaryFile");h.prototype=Object.create(d.prototype);h.prototype.constructor=new d;h.prototype.init=function(){this.loaded=!1;this.magic_number=1195986256;this.cCanvas=
null;this.headers=[{type:"uint32",label:"header_size"},{type:"uint32",label:"version"},{type:"uint32",label:"width"},{type:"uint32",label:"height"},{type:"uint32",label:"bytes"},{type:"uint32",label:"magic_number"},{type:"uint32",label:"spacing"}];this.FH={header_size:0,version:1,width:2,height:3,bytes:4,magic_number:5,spacing:6}};h.prototype._success=function(a){this.loaded=!1;if(this.parse_response(a))return this.loaded=!0,"_success"in this.callback&&this.callback._success.call(this,a),!0;this.init();
return!1};h.prototype.parse_response=function(a){var d=this.FH;10<j.graphit.debug&&i.log("[File/GBR] Parsing header",this.src);for(var a=new DataView(a.response,0),e=0,f=0;f<this.headers.length;f++)this.headers[f].value=a.getInt32(e),10<j.graphit.debug&&i.log(this.headers[f].label,this.headers[f].value),e+=4;if(this.headers[d.magic_number].value!=this.magic_number)return i.error("Trying to load file that is not a GIMP GBR (Brush)"),!1;for(var f=this.headers[d.header_size].value,h="",t=0;t<f;t++)h+=
String.fromCharCode(a.getInt8(e)),e+=1;this.name=h;f=null;f=this.headers[d.bytes].value;if(4==f)label_type="RGBA",f=this._canvas_store_rgba;else if(1==f)label_type="GRAYSCALE",f=this._canvas_store_grayscale;else return i.log("Dunnot know how parsing format with bytes => ",f),!1;d=new Ccanvas({width:this.headers[d.width].value,height:this.headers[d.height].value});d.clear(new Ccolor({a:1}));for(var h=d.getContext("2d"),t=h.getImageData(0,0,d.width,d.height),r=0;e<a.byteLength;e++)r+=f(t,a,r,e);h.putImageData(t,
0,0);this.cCanvas=d;return!0};h.prototype._canvas_store_rgba=function(a,d,e,f){a.data[e]=d.getUint8(f);return 1};h.prototype._canvas_store_grayscale=function(a,d,e,f){a.data[e]=d.getUint8(f);a.data[e+1]=d.getUint8(f);a.data[e+2]=d.getUint8(f);a.data[e+3]=255;return 4};h.prototype.dom_build=function(){var a=$("<div />");this.loaded?a.append(this.cCanvas.dom_get()):a.append("<p>Failed to load Gimp gbr file: "+this.src+"</p>");this.rootElm=a;return this};h.prototype._error=function(){this.init();"_error"in
this.callback&&this.callback._error.call(this)};f.export(e,h)})(window,graphit,console);(function(j,f,i){var h=f.import("lib/object"),e=f.import("lib/menu"),d=f.import("app/toolbox"),a=f.import("app/jquery/theme"),k=f.import("app/license"),l=f.import("app/grapher"),n=f.import("lib/parameter/numeric"),m=f.import("app/surface/workspace"),t=f.import("app/surface"),r=f.import("lib/canvas"),q=new (f.import("lib/po")),s=function(a){a=a||{};a.className="app/graphit";a.label="graphit";a.widgets={};this.surfaces=[];this.selected=null;h.call(this,a,["widgets"]);this.dialog_options={position:"right top"};
this.dom_get();this.surface_create({parent:this,width:400,height:400})};s.prototype=Object.create(h.prototype);s.prototype.constructor=new h;s.prototype.init=function(){var f=this;this.bind_trigger(this,"create_surface",function(a,d){f.surface_create(d)});this.bind_trigger(this,"display_new_surface",function(){f.dialog_new_surface().dialog("open").dialog("moveToTop")});this.bind_trigger(this,"display_widget",function(a,d){f.get_widget(d).dialog("open").dialog("moveToTop")});this.wJquerytheme=new a;
this.wAbout=new k;this.wLogin=j.graphit.auth;var h=j.graphit.baseRestContent,n={cssClass:"disable",label:q.get("menu_login"),callback_click:function(){var a="",a=j.graphit.auth?h+"gi/login":j.graphit.baseStaticContent+"pages/no-authentication.htm";try{j.open(a,"graphit_oauth","width=900,height=600").focus()}catch(d){this.exception("cant_talk_to_opener",d)}}};this.cMenu=new e({parent:null,type:"jquery",label:"graphit_menu",entries:{files:{label:q.get("menu_file"),entries:{new_surface:{label:q.get("menu_new_surface"),
callback_click:function(){f.send_trigger("display_new_surface")}}}},edition:{label:q.get("menu_edition"),entries:{toolbox:{label:q.get("menu_toolbox"),callback_click:function(){f.send_trigger("display_widget",f.cToolbox)}}}},login:n,help:{label:q.get("menu_help"),entries:{theme:{label:q.get("menu_theme"),callback_click:function(){f.send_trigger("display_widget",f.wJquerytheme)}},about:{label:q.get("menu_about"),callback_click:function(){f.send_trigger("display_widget",f.wAbout)}}}}}});this.cToolbox=
new d({parent:this});this.bind_trigger(this.cToolbox,"update",function(){});this.cGrapher=new l({parent:this});this.bind_trigger(this.cGrapher,"update",function(){});this.keybindings={n:{label:"pen",callback:function(){f.cToolbox.select_tool_by_name("pen");return!1}},p:{label:"brush",callback:function(){f.cToolbox.select_tool_by_name("brush");return!1}},"Shift+e":{label:"eraser",callback:function(){f.cToolbox.select_tool_by_name("eraser");return!1}},"Ctrl+z":{label:"undo",callback:function(a){a.preventDefault();
a.stopPropagation();a.stopImmediatePropagation();if(!f.selected)return i.warn("No surface selected to call undo"),!1;f.selected.undo();return!1}}};for(var m in this.keybindings)$(document).bind("keydown",m,this.keybindings[m].callback);this.send_trigger("display_widget",this.cToolbox)};s.prototype.get_widget=function(a){"dom_get"in a||this.exception("method_object_missing","dom_get");if(a.label in this.widgets)return this.widgets[a.label];var d={closeOnEscape:!0,modal:!0};if("dialog_options"in a)for(label in a.dialog_options)d[label]=
a.dialog_options[label];d=a.dom_get().dialog(d);return this.widgets[a.label]=d};s.prototype.dialog_new_surface=function(){if("new_surface"in this.widgets)return this.widgets.new_surface;var a=this,d=$("<div />").attr("title","New Csurface"),e=$("<div />").addClass("group group-new-surface"),f=new n({label:"width",bAutosave:!1,parent:this,min:1,max:1920,step:1,def:400}),h=new n({label:"height",parent:this,bAutosave:!1,min:1,max:1280,step:1,def:400});e.append(f.dom_get(),h.dom_get());d.append(e);d.dialog({modal:!1,
closeOnEscape:!0,stack:!0,zIndex:10,buttons:{Ok:function(){var d=$(this).parent();a.send_trigger("create_surface",{width:d.find(".width input").attr("value"),height:d.find(".height input").attr("value")})},Cancel:function(){$(this).dialog("close")}}});return this.widgets.new_surface=d};s.prototype.surface_create=function(a){var d=this;a.parent=this;var e=null;try{e=new m(a)}catch(f){return i.error("Cannot create surface, Exception <<< ",f," >>>"),!1}if(!e)return!1;this.bind_trigger(e.cSurface,"surface_selected",
function(a,e){e instanceof t||d.exception("invalid_surface_selected_parameter");e.attach_graphit(d);d.selected=e});widget_factory(e.dom_get(),{width:parseInt(a.width)+100});this.surfaces.push(e);this.selected||(this.selected=e);this.dom_build_add_surface(e);return!0};s.prototype.dom_build_add_surface=function(a){var d=this,e=$('<div class="group group-graphit-surface" />'),f=new r({width:50,height:50}),h=a.cSurface;h.canvas_preview=f;f.copy({src:h.cCanvas});e.append(f.dom_get());this.rootElm.find(".group-graphit-surfaces").append(e);
h.bind_trigger(h,"redraw_preview",function(a,d){h.canvas_preview.copy({src:d.cCanvas,resize:!0})});e.click(function(){h.send_trigger("surface_selected",h);cEach(d.surfaces,function(a,d){d.cSurface==h&&d.rootElm.parent().dialog("open").dialog("moveToTop")});$(this).parent().find(".group-graphit-surface").removeClass("selected");$(this).addClass("selected")});return this};s.prototype.dom_build=function(){var a=$("<div />"),d=$('<div class="group group-menu" />');d.append(this.cMenu.dom_get());a.append(d);
d=$('<div class="group group-graphit-surfaces"/>');cEach(this.surfaces,function(a,e){var f=$('<div class="graphit-surface" />'),h=new r({width:50,height:50});h.copy(e.cCanvas,!0);f.append(h.dom_get());d.append(f)});a.append(d);for(var e=j.graphit.baseStaticContent+"/",f=$('<div class="group group-badge">'),h=["html5","vcss","zf2","gplv3"],i=0;i<h.length;i++){var k=$('<img class="badge" />');k.attr("width",32);k.attr("src",e+"images/badge-"+h[i]+"-32.png");f.append(k)}a.append(f);this.rootElm=a;return this};
s.prototype.list=function(a){for(var d=0;d<this.surfaces.length;d++)a.call(this,d,this.surfaces[d]);return this.surfaces.length};f.export("app/graphit",s)})(window,graphit,console);(function(j,f,i,h){function e(a){var e=this,a=a||{};a.className="CgraphitAuth";a.label="CgraphitAuth";a.disable=a.disable!=h?a.disable:!1;this.selected=null;a.dialog_options=a.dialog_options||{modal:!1,width:200};this.__init_singleton(a);d.call(this,a,["dialog_options"]);this.hasValidAccount();this.bind_trigger(this,"update",function(){e.update()})}var d=f.import("lib/object");e.prototype=Object.create(d.prototype);e.prototype.constructor=new d;e.prototype.hasValidAccount=function(){var a=j.graphit;
if(!("storage"in a))return null;a=a.storage.get("chooserAccounts");return!a?null:a=JSON.parse(a)};e.prototype.__init_singleton=function(a){"__data"in e||(e.__data={});"__disable"in e||(e.__disable=a.disable)};e.prototype.copy=function(a){for(key in a.get_data())i.log("Copy",key),this.set(key,a.get(key))};e.prototype.get_data=function(){return e.__data};e.prototype.is_logged=function(){return this.get("verifiedEmail")};e.prototype.is_disable=function(){return e.__disable};e.prototype.set=function(a,
d){i.log("Auth",a,d);e.__data[a]=d};e.prototype.get=function(a){return!(a in e.__data)?(i.warn("key doesn't exists",a),null):e.__data[a]};e.prototype.each=function(a){if(!a||"function"!=typeof a)throw"invalid_callback";for(var d in e.__data)a.call(e.__data,d,this.get(d))};e.prototype.dom_get=function(a){return this.rootElm&&(a==h||!a)?this.rootElm:this.dom_build().rootElm};e.prototype.__replace_accounts=function(){var a=this,d=this.rootElm.children(".group-graphit-authentication").empty(),e=this.hasValidAccount();
cEach(e,function(e,f){var h=$("<div />"),j=$("<img />");j.addClass("photoUrl");j.attr("src",f.photoUrl);j.attr("alt","photoUrl");h.append(j);h.append('<b class="displayName">'+f.displayName+"</b>");h.append('<b class="email">'+f.email);a.ajax_is_logged({email:f.email,callback_error:function(){i.warn("removing email",f.email)}});d.append(h)});if(e&&0<e.length){var e=$('<div class="logout" />'),f=$("<button />");f.append(T("menu_logout"));f.button({});f.click(function(){j.graphit.storage.remove("chooserAccounts");
deleteAllCookies();a.ajax_logout({email:"",callback_success:function(){i.log("logout");d.empty()}});a.send_trigger("update")});e.append(f);d.append(e)}};e.prototype.update=function(){this.__replace_accounts()};e.prototype.dom_build=function(){var a=$('<div title="Graphit Authentication"/>'),d=$("<div  />");d.addClass("group group-graphit-authentication");a.append(d);this.rootElm=a;this.__replace_accounts();return this};e.prototype.ajax_is_logged=function(a){var d=this,e=$.ajax({type:"POST",url:j.graphit.baseRestContent+
"gi/logged",data:{email:a.email}});"callback_succces"in a?e.done(function(e){a.callback_succes.call(d,e)}):"callback_error"in a&&e.error(function(e,f){a.callback_error.call(d,e,f)})};e.prototype.ajax_logout=function(a){var d=this,e=$.ajax({type:"POST",url:j.graphit.baseRestContent+"gi/logout",data:{email:a.email}});"callback_success"in a?e.done(function(e){a.callback_success.call(d,e)}):"callback_error"in a&&e.error(function(e,f){a.callback_error.call(d,e,f)})};f.export("CgraphitAuth",e)})(window,
graphit,console);(function(j,f,i){var h=f.debug,e=f.import("lib/object"),d=function(a){a=a||{};a.className="app/browser";a.label="app/browser";e.call(this,a,[])};d.prototype=Object.create(e.prototype);d.prototype.constructor=new e;d.prototype.get_language=function(){var a=navigator.language?navigator.language:navigator.userLanguage,d=/^\s*([^-]*)-([^\s]*)\s*$/.exec(a);return d?d[1]:a};d.prototype.get_language=d.prototype.get_language;d.prototype.is_file_supported=function(){if(j.File&&j.FileReader&&j.FileList&&j.Blob)return!0;
i.error("The File APIs are not fully supported in this browser.");return!1};d.prototype.is_file_supported=d.prototype.is_file_supported;d.prototype.is_canvas_supported=function(){var a=document.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))};d.prototype.is_canvas_supported=d.prototype.is_canvas_supported;d.prototype.__test=function(){var a=new (f.import("app/browser")),d="File supported: ",d=a.is_file_supported()?d+"yes":d+"no",d=d+"\nCanvas supported: ",d=a.is_canvas_supported()?
d+"yes":d+"no";h&&i.log(d);return!0};d.prototype.__test=d.prototype.__test;f.export("app/browser",d)})(window,graphit,console);(function(j,f,i){j=function(){i.log("[ Starting ]");var h=0,e=0,d;for(d in f.egg){h++;var a=null,j="[ Testing ] "+h+" / "+d+" / ",l=f.egg[d].prototype;if(l){var n=!1;if("__test"in l){try{f.import(d),n=l.__test.call(o),n=!0,e++}catch(m){a={original:m,message:m.message},"object"===typeof m&&"to_s"in m&&(a.to_s=m.to_s())}n?i.log(j+"Ok"):(i.log(j+"Fail"),i.error("Error in <<< ",d," >>>"),i.error(a,a.original),"shojs-exception"==a.original.type&&widget_exception(a.original))}else i.log(j+" NO TEST"),e++}else i.log(j,
f.egg[d]),e++}i.log("Test ",e," / ",h)};j.prototype.__test=function(){return!0};f.export("app/boot/test",j)})(window,graphit,console);(function(j,f){var i=function(){(new (f.import("app/graphit"))).dom_get().dialog()};i.prototype.__test=function(){return!0};f.export("app/boot",i)})(window,graphit,console);
